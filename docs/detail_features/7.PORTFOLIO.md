# 포트폴리오 기능 명세서

포트폴리오는 **등록 종목의 투자 현황·비중·추이·기여도**를 시각화하고, **진단·조정 제안·종목 건강 점검**을 제공하는 페이지로, `/portfolio` 경로에서 접근한다.

---

## 1. 화면 구성

```
┌──────────────────────────────────────────────────────────────────┐
│  PageHeader ("Portfolio" / "포트폴리오 대시보드")                   │
├──────────────────────────────────────────────────────────────────┤
│  PortfolioSummaryCards — 총 투자금액, 평가금액, 손익, 수익률        │
│  투자 종목 N개 | 관찰 종목 N개                                      │
├──────────────────────────────────────────────────────────────────┤
│  [AllocationPieChart]  [PortfolioTrendChart]  (2열 그리드)          │
│  포트폴리오 비중 (파이)  수익률 추이 (AreaChart)                     │
├──────────────────────────────────────────────────────────────────┤
│  ContributionTable — 종목별 기여도 테이블                           │
│  관찰 중인 종목 (뱃지 링크)                                         │
├──────────────────────────────────────────────────────────────────┤
│  [포트폴리오 분석 리포트] 토글 버튼                                  │
├──────────────────────────────────────────────────────────────────┤
│  ※ 토글 시: PortfolioAnalysisReport                               │
│  - 면책 배너                                                        │
│  - 포트폴리오 진단                                                   │
│  - 조정 제안                                                        │
│  - 관찰 종목 동향                                                   │
│  - 보유 종목 건강 점검                                              │
└──────────────────────────────────────────────────────────────────┘
```

---

## 2. 투자/관찰 분류

**classifyETFs (utils/portfolio.js):**

| 분류 | 조건 |
|------|------|
| **투자 종목** | `purchase_price` && `quantity` 둘 다 있을 때 |
| **관찰 종목** | 매입가·수량이 없거나 하나라도 없을 때 |

- 포트폴리오 분석은 **투자 종목만** 대상
- 관찰 종목은 ContributionTable 하단에 링크로 표시, 분석 리포트의 "관찰 종목 동향"에서 다룸

---

## 3. 데이터 흐름

### 사용하는 API

| 순서 | API | 용도 | 캐시 정책 |
|------|-----|------|----------|
| 1 | `GET /api/etfs` | 전체 종목 목록 | staleTime 5분 |
| 2 | `POST /api/etfs/batch-summary` | 투자 종목 가격·매매동향 일괄 조회 | staleTime 30초 |

### batch-summary 요청

- `tickers`: 등록된 전체 종목
- `price_days`: 30 (포트폴리오는 30일 가격 사용)
- `news_limit`: 1

### 응답 구조 (batchSummary)

`{ ticker: ETFCardSummary }` 형태

- `prices`: 일자별 가격 배열 (최신순, date, close_price 등)
- `latest_price`: 최신 가격
- `weekly_return`: 주간 수익률
- `latest_trading_flow`: 최근 1일 매매동향 (foreign_net, institutional_net)

---

## 4. 계산 유틸리티 (utils/portfolio.js)

### 4-1. calculatePortfolioSummary

| 출력 | 계산식 |
|------|--------|
| totalInvestment | Σ(매입가 × 수량) |
| totalValuation | Σ(최신가 × 수량) |
| totalProfitLoss | totalValuation - totalInvestment |
| totalReturnPct | (totalProfitLoss / totalInvestment) × 100 |

### 4-2. calculateAllocation

| 출력 | 설명 |
|------|------|
| ticker, name, theme | 종목 정보 |
| value | 최신가 × 수량 |
| percent | value / 총 평가액 × 100 |

### 4-3. calculateDailyPortfolioTrend

| 출력 | 설명 |
|------|------|
| date | 거래일 |
| portfolioValue | Σ(해당 일 close_price × 수량) |
| returnPct | (portfolioValue - totalInvestment) / totalInvestment × 100 |

- 날짜별로 종목 가치 합산 후 오름차순 정렬

### 4-4. calculateContribution

| 출력 | 설명 |
|------|------|
| ticker, name | 종목 정보 |
| investment | 매입가 × 수량 |
| valuation | 최신가 × 수량 |
| profitLoss | valuation - investment |
| returnPct | (profitLoss / investment) × 100 |
| contribution | (profitLoss / totalInvestment) × 100 (%p) |

- 기여도 내림차순 정렬

---

## 5. 컴포넌트 상세

### 5-1. PortfolioSummaryCards

**요약 카드 4개:**

| 라벨 | 값 | 색상 |
|------|-----|------|
| 총 투자금액 | totalInvestment | 기본 |
| 총 평가금액 | totalValuation | 기본 |
| 총 손익 | totalProfitLoss | 상승=빨강, 하락=파랑 |
| 총 수익률 | totalReturnPct | 상승=빨강, 하락=파랑 |

**하단:** 투자 종목 N개, 관찰 종목 N개

### 5-2. AllocationPieChart

- recharts PieChart
- data: allocation 배열 (name, value, percent)
- 5% 미만 비중: 라벨 미표시
- CHART_COLOR_PALETTE로 색상 지정
- 툴팁: formatPrice(value), 범례: name

### 5-3. PortfolioTrendChart

- recharts AreaChart
- data: trend 배열 (date, portfolioValue, returnPct)
- X축: date (MM-DD), Y축: returnPct (%)
- ReferenceLine: y=0
- 그라데이션: 수익 시 빨강, 손실 시 파랑

### 5-4. ContributionTable

**테이블 컬럼:**
| 종목명 | 투자금액 | 평가금액 | 손익 | 수익률 | 기여도 |
|--------|----------|----------|------|--------|--------|
| Link | formatPrice | formatPrice | formatPrice | formatPercent | N%p |

- 종목명 클릭 → `/etf/:ticker`
- 기여도 내림차순(이미 정렬됨)

**관찰 중인 종목:**
- trackingETFs를 뱃지 형태로 표시, 클릭 시 ETF 상세로 이동

### 5-5. PortfolioAnalysisReport (토글)

**면책 배너:**
- "본 분석은 참고용이며, 투자 판단의 근거로 사용하지 마세요"

**A. 포트폴리오 진단**
- 총 수익률, 최대 기여 종목, 최대 드래그 종목
- 집중 리스크: 단일 종목 >40%, 테마 >60% 시 경고

**B. 조정 제안**
- generateAdjustmentSuggestions 결과
- 액션: stop_loss(손절 검토), trim(비중 축소), buy(신규/분할 매수), hold
- severity: high/medium/low → 좌측 border 색상

**C. 관찰 종목 동향**
- analyzeWatchedStocks 결과
- 컬럼: 종목명, 일간, 주간, 수급, 평가
- highlight: 강한 모멘텀 또는 외국인+기관 매수 시 배경 강조

**D. 보유 종목 건강 점검**
- checkHoldingsHealth 결과
- 컬럼: 종목명, 수익률, 기여도, 수급, 상태, 비고
- returnStatus: profit/slight_loss/warning/danger
- tradingFlowSignal: positive(매수)/negative(매도)/neutral(혼조)

---

## 6. 분석 유틸리티 (utils/portfolioAnalysis.js)

### 6-1. diagnosePortfolio

- **집중 리스크:** 단일 종목 >40%, 테마 >60%
- **최대 기여/드래그:** contribution 기준

### 6-2. analyzeWatchedStocks

- 관찰 종목별 일간, 주간, 수급 방향, 모멘텀, assessment 텍스트
- highlight: strong_up 또는 both_buy

### 6-3. generateAdjustmentSuggestions

- 손절(-10% 이하), 비중 축소(단일 >40%), 신규 편입(관찰 종목 강한 모멘텀), 부진+매도(수익률 -5%~-10% & 수급 부정적), 눌림목 매수
- 최대 5개 반환

### 6-4. checkHoldingsHealth

- returnStatus: 수익률 구간별 (profit, slight_loss, warning, danger)
- tradingFlowSignal: 수급 방향

---

## 7. UI 상태별 처리

| 상태 | 표시 |
|------|------|
| **로딩** | Spinner (etfsLoading \|\| summaryLoading) |
| **에러** | ErrorFallback |
| **투자 종목 0개** | "투자 종목이 없습니다" + Settings 안내 |
| **정상** | 요약 카드, 차트, 테이블, 분석 리포트 토글 |

---

## 8. 상태 관리

| 상태 | 저장소 | 용도 |
|------|--------|------|
| etfs | React Query | 종목 목록 |
| batchSummary | React Query | batch-summary-portfolio |
| invested, trackingOnly | useMemo(classifyETFs) | 분류 결과 |
| summary | useMemo(calculatePortfolioSummary) | 요약 |
| allocation | useMemo(calculateAllocation) | 비중 |
| trend | useMemo(calculateDailyPortfolioTrend) | 일별 추이 |
| contributions | useMemo(calculateContribution) | 기여도 |
| showAnalysisReport | useState | 분석 리포트 펼침/접힘 |

---

## 9. 관련 파일

### 프론트엔드

| 파일 | 역할 |
|------|------|
| `pages/Portfolio.jsx` | 페이지 컨테이너, 데이터 조회·계산·렌더링 |
| `components/portfolio/PortfolioSummaryCards.jsx` | 요약 카드 |
| `components/portfolio/AllocationPieChart.jsx` | 파이 차트 |
| `components/portfolio/PortfolioTrendChart.jsx` | 수익률 추이 차트 |
| `components/portfolio/ContributionTable.jsx` | 기여도 테이블 |
| `components/portfolio/PortfolioAnalysisReport.jsx` | 분석 리포트 |
| `utils/portfolio.js` | classifyETFs, calculatePortfolioSummary, calculateAllocation, calculateDailyPortfolioTrend, calculateContribution |
| `utils/portfolioAnalysis.js` | generatePortfolioReport, diagnosePortfolio, analyzeWatchedStocks, generateAdjustmentSuggestions, checkHoldingsHealth |
| `services/api.js` | etfApi.getAll, etfApi.getBatchSummary |

### 백엔드

| 파일 | API |
|------|-----|
| `routers/etfs.py` | GET /api/etfs, POST /api/etfs/batch-summary |
