# 알림 기능 명세서

알림 기능은 **목표가·급등/급락·매매 시그널**을 감지하여 토스트와 알림 이력을 표시하는 기능이다. 알림 **규칙 설정**은 종목 상세(`/etf/:ticker`)의 PriceTargetPanel에서, **이력 조회**는 `/alerts` 페이지에서 이루어진다.

---

## 1. 화면 구성

### 1-1. 알림 페이지 (`/alerts`)

```
┌──────────────────────────────────────────────────────────────────┐
│  제목: "알림 관리"                                                 │
│  부제: "알림 규칙 설정과 알림 이력을 확인하세요"                     │
├──────────────────────────────────────────────────────────────────┤
│  필터 [전체] [목표가] [급등/급락] [매수 시그널] [매도 시그널] [모두 지우기] │
├──────────────────────────────────────────────────────────────────┤
│  알림 이력 리스트 (또는 빈 상태 안내)                               │
│  각 항목: 알림 메시지, 타입 라벨, 시각 | 클릭 시 /etf/:ticker       │
├──────────────────────────────────────────────────────────────────┤
│  안내: 종목 상세에서 알림 설정, 브라우저 푸시 추후 지원              │
└──────────────────────────────────────────────────────────────────┘
```

### 1-2. Header 벨 아이콘

- 벨 클릭 → 드롭다운 (최근 알림 미리보기)
- `unreadCount > 0` 시 빨간 뱃지 표시
- 클릭 시 `markAllRead()` 호출
- [전체 보기] → `/alerts`
- [알림 관리] 링크

---

## 2. 데이터 흐름

### 2-1. 알림 이력 (세션 내 메모리)

| 저장소 | 용도 |
|--------|------|
| **AlertContext** | useAlertChecker에서 발생한 알림 저장 (메모리) |
| pushAlert | 토스트 표시 후 알림 이력에 추가 |
| 최대 50개 유지 | `.slice(0, 50)` |
| 페이지 새로고침 시 | 초기화됨 |

### 2-2. 알림 규칙 (서버)

| API | 용도 |
|-----|------|
| `GET /api/alerts/{ticker}` | 종목별 규칙 조회 (active_only) |
| `POST /api/alerts/` | 규칙 생성 |
| `PUT /api/alerts/{rule_id}` | 규칙 수정 (is_active 등) |
| `DELETE /api/alerts/{rule_id}` | 규칙 삭제 |
| `POST /api/alerts/trigger` | 트리거 기록 (fire-and-forget) |
| `GET /api/alerts/history/{ticker}` | 종목별 서버 이력 (limit, 현재 Alerts 페이지에서 미사용) |

---

## 3. 알림 타입

| alert_type | 라벨 | 설정 위치 | 감지 조건 |
|------------|------|----------|----------|
| **buy** | 매수 시그널/목표가 | PriceTargetPanel 목표가 탭 | 분봉 현재가가 목표가 도달 (below/above) |
| **sell** | 매도 시그널/목표가 | PriceTargetPanel 목표가 탭 | 분봉 현재가가 목표가 도달 (below/above) |
| **price_change** | 급등/급락 | PriceTargetPanel 급등/급락 탭 | 장중 등락률이 임계값 초과 |
| **trading_signal** | 매매 시그널 | PriceTargetPanel 매매시그널 탭 | 외국인·기관 동시 매수/매도 |

---

## 4. useAlertChecker (알림 감지)

**사용 위치:** ETFDetail 페이지

**입력:** ticker, tickerName, alertRules, intradayData, previousClose, tradingFlowData

### 4-1. 목표가 (buy/sell)

- **데이터:** `intradayData.data` 마지막 가격
- **조건:** `direction: below` → 현재가 ≤ 목표가, `above` → 현재가 ≥ 목표가
- **중복 방지:** `firedRef` (rule.id + alert_type)

### 4-2. 급등/급락 (price_change)

- **데이터:** `intradayData`, `previousClose`로 등락률 계산
- **조건:** direction별
  - `above`: 등락률 ≥ target_price(임계 %)
  - `below`: 등락률 ≤ -target_price
  - `both`: |등락률| ≥ target_price

### 4-3. 매매 시그널 (trading_signal)

- **데이터:** `tradingFlowData[0]` (최신 1일)
- **조건:** `foreign_net`, `institutional_net` 기반
  - `both`: 동시 매수 또는 동시 매도
  - `above`: 동시 매수만
  - `below`: 동시 매도만
- **중복 방지:** `lastTradingFlowDateRef` (같은 날짜 재체크 방지)

### 4-4. 알림 발생 시

1. Toast 표시 (5초)
2. `alertStore.pushAlert({ ticker, tickerName, alert_type, message })`
3. `alertApi.recordTrigger({ rule_id, ticker, alert_type, message })` (비동기)

---

## 5. PriceTargetPanel (규칙 설정)

**위치:** ETFDetail 페이지 내

### 5-1. 탭

| 탭 | 규칙 타입 |
|----|----------|
| 목표가 | buy, sell |
| 급등/급락 | price_change |
| 매매시그널 | trading_signal |

### 5-2. 목표가 폼

- 매수 목표 / 매도 목표 버튼
- 현재가 기준 % 입력 → 목표가 자동 계산
- 퀵 버튼: -10, -5, -3, -1, 1, 3, 5, 10%
- 목표가 직접 입력, direction (이하/이상)

### 5-3. 급등/급락 폼

- target_price: 임계 % (0.1~100)
- direction: both / above / below

### 5-4. 매매시그널 폼

- direction: both / above / below
- target_price: 0 (고정)

### 5-5. RuleItem

- 토글(활성/비활성), 수정, 삭제
- 라벨: 목표가·등락률·시그널 유형 표시

---

## 6. Alerts 페이지 상세

### 6-1. 필터

| 키 | 라벨 | 매칭 alert_type |
|----|------|-----------------|
| all | 전체 | - |
| price_target | 목표가 | price_target (저장된 alert_type은 buy/sell이므로 매칭 안 됨) |
| price_change | 급등/급락 | price_change |
| buy | 매수 시그널 | buy |
| sell | 매도 시그널 | sell |

**참고:** `price_target` 필터는 alert_type이 `price_target`인 항목만 표시하는데, 실제 저장 값은 buy/sell이므로 매칭되지 않는다. 목표가 알림은 buy/sell 필터로 확인 가능하다.

### 6-2. 알림 항목

- message, typeLabel, timestamp
- 클릭 → `/etf/:ticker`
- 타입별 점 색상: buy=빨강, sell=파랑, price_change=주황, 기타=보라

### 6-3. 모두 지우기

- `clearAll()` → alerts 배열 비우기, unreadCount 0

---

## 7. AlertContext

| 상태 | 타입 | 설명 |
|------|------|------|
| alerts | Array | { id, ticker, tickerName, alert_type, message, timestamp, read } |
| unreadCount | number | 미읽음 개수 |
| pushAlert | function | 알림 추가 |
| markAllRead | function | 모두 읽음 처리 |
| clearAll | function | 전체 삭제 |

---

## 8. 관련 API

| 메서드 | 경로 | 설명 |
|--------|------|------|
| GET | /api/alerts/{ticker} | 규칙 목록 (active_only) |
| POST | /api/alerts/ | 규칙 생성 |
| PUT | /api/alerts/{rule_id} | 규칙 수정 |
| DELETE | /api/alerts/{rule_id} | 규칙 삭제 |
| POST | /api/alerts/trigger | 트리거 기록 |
| GET | /api/alerts/history/{ticker} | 서버 이력 (limit) |

---

## 9. 관련 파일

### 프론트엔드

| 파일 | 역할 |
|------|------|
| `pages/Alerts.jsx` | 알림 이력 페이지 |
| `contexts/AlertContext.jsx` | 알림 이력 저장소 |
| `hooks/useAlertChecker.js` | 3종 알림 감지 |
| `components/etf/PriceTargetPanel.jsx` | 규칙 CRUD UI |
| `components/layout/Header.jsx` | 벨 아이콘, 드롭다운 |

### 백엔드

| 파일 | API |
|------|-----|
| `routers/alerts.py` | /api/alerts/* |
