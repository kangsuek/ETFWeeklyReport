# 시뮬레이션 기능 명세서

시뮬레이션은 **과거 데이터 기반 투자 시뮬레이션**을 제공하는 페이지로, `/simulation` 경로에서 접근한다. "그때 샀다면?" 시나리오를 시뮬레이션한다.

---

## 1. 화면 구성

```
┌──────────────────────────────────────────────────────────────────┐
│  제목: "시뮬레이션"                                                 │
│  부제: "과거 데이터 기반 투자 시뮬레이션 — 그때 샀다면?"             │
├──────────────────────────────────────────────────────────────────┤
│  탭 [일시 투자] [적립식 투자] [포트폴리오]                           │
├──────────────────────────────────────────────────────────────────┤
│  ※ 일시 투자 탭: LumpSumSimulation                                 │
│  ※ 적립식 투자 탭: DCASimulation                                   │
│  ※ 포트폴리오 탭: PortfolioSimulation                              │
└──────────────────────────────────────────────────────────────────┘
```

---

## 2. 공통 사항

### 사용하는 API

| API | 용도 |
|-----|------|
| `GET /api/etfs` | 종목 목록 (드롭다운용) |
| `POST /api/simulation/lump-sum` | 일시 투자 시뮬레이션 |
| `POST /api/simulation/dca` | 적립식 투자 시뮬레이션 |
| `POST /api/simulation/portfolio` | 포트폴리오 시뮬레이션 |

- 시뮬레이션 API: `useMutation`, `LONG_API_TIMEOUT` (30분)
- 종목 목록: `useQuery` `['etfs']`

### 공통 UI 패턴

- **폼** → **에러** → **로딩** → **결과** 순서
- 에러: 빨간 배경 박스, `mutation.error?.response?.data?.detail` 또는 `mutation.error?.message`
- 로딩: 스피너 + "데이터 수집 및 분석 중..."
- 숫자 입력: `toComma`/`fromComma` (콤마 포맷), `/^\d*$/` 숫자만 허용

---

## 3. 일시 투자 (LumpSumSimulation)

### 3-1. 폼

| 필드 | 타입 | 기본값 | 검증 |
|------|------|--------|------|
| 종목 | select | 빈 문자열 | required |
| 매수일 | date | 빈 문자열 | required, `max={today}` |
| 투자금 (원) | text (숫자) | 1,000,000 | required, 숫자만 |
| [시뮬레이션] | submit | - | mutation.isPending 시 disabled |

### 3-2. 결과

**요약 카드 (4개):**
- 투자금: `total_invested`
- 현재 평가액: `total_valuation` (수익률에 따라 빨강/파랑)
- 수익률: `total_return_pct`
- 매수 주수: `shares`주, 잔여금 `remainder`

**최대 수익/손실 카드 (2개):**
- 최대 수익: `max_gain.date`, `max_gain.price`, `max_gain.return_pct`
- 최대 손실: `max_loss.date`, `max_loss.price`, `max_loss.return_pct`

**평가액 추이 차트 (LineChart):**
- X축: date (MM-DD)
- Y축: valuation (만원 단위)
- ReferenceLine: 투자금 기준선
- 데이터: `price_series` (date, valuation, return_pct)

### 3-3. API

**POST /api/simulation/lump-sum**

Request:
```json
{
  "ticker": "487240",
  "buy_date": "2024-01-15",
  "amount": 1000000
}
```

Response:
```json
{
  "ticker": "487240",
  "name": "KODEX 2차전지테마",
  "buy_date": "2024-01-15",
  "buy_price": 12500,
  "current_date": "2025-02-12",
  "current_price": 14200,
  "shares": 80,
  "remainder": 0,
  "total_invested": 1000000,
  "total_valuation": 1136000,
  "total_return_pct": 13.6,
  "max_gain": { "date": "2025-01-10", "price": 15000, "return_pct": 20.0 },
  "max_loss": { "date": "2024-03-01", "price": 11500, "return_pct": -8.0 },
  "price_series": [{ "date": "2024-01-15", "valuation": 1000000, "return_pct": 0 }, ...]
}
```

---

## 4. 적립식 투자 (DCASimulation)

### 4-1. 폼

| 필드 | 타입 | 기본값 | 검증 |
|------|------|--------|------|
| 종목 | select | 빈 문자열 | required |
| 월 투자금 (원) | text (숫자) | 500,000 | required |
| 매수일 (매월) | select | 1 | 1~28일 |
| 시작일 | date | 빈 문자열 | required, `max={today}` |
| 종료일 | date | 빈 문자열 | required, `max={today}` |
| [시뮬레이션] | submit | - | mutation.isPending 시 disabled |

**매수일:** 1일~28일 드롭다운 (28일: 2월 등 짧은 달은 말일 자동 적용)

### 4-2. 결과

**요약 카드 (5개):**
- 총 투자금, 현재 평가액, 수익률, 평균 매수가, 총 보유 주수

**차트 (AreaChart):**
- 누적 투자금 vs 평가액
- X축: date (YY-MM)
- 데이터: `monthly_data` (cumulative_invested, cumulative_valuation)

**월별 매수 내역 테이블:**
| 날짜 | 매수가 | 매수 주수 | 누적 주수 | 누적 투자금 | 평가액 | 수익률 |

### 4-3. API

**POST /api/simulation/dca**

Request:
```json
{
  "ticker": "487240",
  "monthly_amount": 500000,
  "start_date": "2024-01-01",
  "end_date": "2025-01-31",
  "buy_day": 1
}
```

Response:
```json
{
  "ticker": "487240",
  "name": "KODEX 2차전지테마",
  "total_invested": 6500000,
  "total_valuation": 7200000,
  "total_return_pct": 10.77,
  "avg_buy_price": 12800,
  "total_shares": 500,
  "monthly_data": [
    {
      "date": "2024-01-01",
      "buy_price": 12500,
      "shares_bought": 40,
      "cumulative_shares": 40,
      "cumulative_invested": 500000,
      "cumulative_valuation": 500000,
      "return_pct": 0
    },
    ...
  ]
}
```

**백엔드 검증:** `start_date < end_date`, `buy_day` 1~28

---

## 5. 포트폴리오 시뮬레이션 (PortfolioSimulation)

### 5-1. 폼

**종목 구성:**
- 동적 행: 종목 select + 비중(%) input + [삭제] 버튼
- [균등 배분]: 비중을 100/N으로 균등 배분 (나머지는 1행에)
- [+ 종목 추가]: 새 행 추가
- 최소 1개 종목, 중복 불가 (select에서 이미 선택된 종목 제외)

**비중:**
- 각 행 1~100%, 합계 100% (±1 허용)
- `Math.abs(totalWeight - 100) > 1` 시 submit disabled, 빨간 안내

**기타 필드:**
- 총 투자금 (원): 기본 10,000,000
- 시작일, 종료일: required, `max={today}`

### 5-2. 결과

**요약 카드 (3개):**
- 총 투자금, 현재 평가액, 포트폴리오 수익률

**종목별 결과 테이블:**
| 종목 | 비중 | 배정금 | 매수가 | 주수 | 현재가 | 평가액 | 수익률 |

**포트폴리오 가치 추이 차트 (LineChart):**
- `daily_series` 있을 때만 표시
- ReferenceLine: 투자금
- date, valuation

### 5-3. API

**POST /api/simulation/portfolio**

Request:
```json
{
  "holdings": [
    { "ticker": "487240", "weight": 0.5 },
    { "ticker": "466920", "weight": 0.5 }
  ],
  "amount": 10000000,
  "start_date": "2024-01-01",
  "end_date": "2025-01-31"
}
```

Response:
```json
{
  "total_invested": 10000000,
  "total_valuation": 11200000,
  "total_return_pct": 12.0,
  "holdings_result": [
    {
      "ticker": "487240",
      "name": "KODEX 2차전지테마",
      "weight": 0.5,
      "allocated": 5000000,
      "buy_price": 12500,
      "shares": 400,
      "current_price": 14200,
      "current_valuation": 5680000,
      "return_pct": 13.6
    },
    ...
  ],
  "daily_series": [{ "date": "2024-01-01", "valuation": 10000000, "return_pct": 0 }, ...]
}
```

**백엔드 검증:**
- `start_date < end_date`
- holdings 최소 1개
- 동일 종목 중복 시 400

---

## 6. 캐시 및 데이터 수집

- **백엔드 캐시:** 5분 TTL, 요청 파라미터 기반 캐시 키
- **자동 수집:** 시뮬레이션 서비스 내 `auto_collect_if_needed`로 가격 데이터 부족 시 네이버 금융에서 수집 후 재조회

---

## 7. 상태 관리

| 탭 | 상태 | 저장소 |
|----|------|--------|
| 전체 | activeTab | useState ('lump-sum' \| 'dca' \| 'portfolio') |
| 일시 | ticker, buyDate, amount, mutation | useState, useMutation |
| 적립식 | ticker, monthlyAmount, startDate, endDate, buyDay, mutation | useState, useMutation |
| 포트폴리오 | holdings, amount, startDate, endDate, mutation | useState, useMutation |

---

## 8. 관련 파일

### 프론트엔드

| 파일 | 역할 |
|------|------|
| `pages/Simulation.jsx` | 페이지 컨테이너, 탭 바 |
| `components/simulation/LumpSumSimulation.jsx` | 일시 투자 폼·결과 |
| `components/simulation/DCASimulation.jsx` | 적립식 투자 폼·결과 |
| `components/simulation/PortfolioSimulation.jsx` | 포트폴리오 폼·결과 |
| `services/api.js` | simulationApi.lumpSum, dca, portfolio |

### 백엔드

| 파일 | API |
|------|-----|
| `routers/simulation.py` | POST /api/simulation/lump-sum, dca, portfolio |
| `services/simulation_service.py` | SimulationService.run_lump_sum, run_dca, run_portfolio |
| `models.py` | LumpSumRequest/Response, DCARequest/Response, PortfolioSimulationRequest/Response |
