# 종목 발굴(스캐너) 기능 명세서

종목 발굴(스캐너)은 **조건 기반 ETF/주식 검색**과 **테마별 탐색**을 제공하는 페이지로, `/scanner` 경로에서 접근한다.

---

## 1. 화면 구성

```
┌──────────────────────────────────────────────────────────────────┐
│  PageHeader ("종목 발굴" / "ETF 조건 검색 및 테마 탐색")            │
├──────────────────────────────────────────────────────────────────┤
│  탭 바 [조건 검색] [테마 탐색]          [데이터 수집] 버튼          │
├──────────────────────────────────────────────────────────────────┤
│  [수집 진행률 배너] (수집 중일 때만 표시)                           │
│  메시지 | 진행률 바 | 퍼센트 | [중지] 버튼                          │
├──────────────────────────────────────────────────────────────────┤
│  ※ 조건 검색 탭 활성 시:                                            │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │  ScreeningFilters                                          │  │
│  │  - 종목 검색(입력+검색 버튼)                                │  │
│  │  - 주간수익률 최소/최대, 외국인 순매수, 기관 순매수 체크박스  │  │
│  │  - [초기화] 버튼 | 데이터 갱신 시각                          │  │
│  └────────────────────────────────────────────────────────────┘  │
│  정렬 [드롭다운] [방향 버튼]    뷰 모드 [테이블] [히트맵]           │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │  ScreeningTable 또는 ScreeningHeatmap                       │  │
│  │  (페이지네이션)                                             │  │
│  └────────────────────────────────────────────────────────────┘  │
├──────────────────────────────────────────────────────────────────┤
│  ※ 테마 탐색 탭 활성 시:                                            │
│  ThemeExplorer — 섹터별 카드 그리드 (평균 수익률, Top 3 종목)       │
└──────────────────────────────────────────────────────────────────┘
```

---

## 2. 데이터 흐름

### 사용하는 API

| 순서 | API | 용도 | 캐시 정책 |
|------|-----|------|----------|
| 1 | `GET /api/scanner` | 조건 기반 종목 검색 | staleTime 30초, keepPreviousData |
| 2 | `GET /api/scanner/themes` | 섹터/테마별 그룹 조회 | staleTime 5분 (테마 탐색 탭) |
| 3 | `POST /api/scanner/collect-data` | 카탈로그 데이터 수집 트리거 | - |
| 4 | `GET /api/scanner/collect-progress` | 수집 진행률 조회 | 폴링 2초 간격 (수집 중) |
| 5 | `POST /api/scanner/cancel-collect` | 수집 중지 요청 | - |

### 요청 순서

**조건 검색 탭:**
1. 탭 진입 시 → `GET /api/scanner` (필터 파라미터와 함께)
2. 필터/정렬/페이지 변경 시 → 동일 API 재호출 (`enabled: activeTab === 'search'`)

**테마 탐색 탭:**
1. 탭 진입 시 → `GET /api/scanner/themes`

**데이터 수집:**
1. [데이터 수집] 클릭 → `POST /api/scanner/collect-data`
2. `isCollecting=true` 설정 후 → `GET /api/scanner/collect-progress` 2초 간격 폴링
3. `status=completed` → 폴링 중지, Toast 성공, scanner/themes/recommendations 캐시 무효화
4. `status=cancelled` / `error` → 폴링 중지, Toast 표시

### 페이지 진입 시 동작

- 마운트 시 `getCollectProgress()` 호출하여 이미 수집 중인지 확인
- `status=in_progress`이면 `isCollecting` 활성화 및 폴링 시작

---

## 3. 컴포넌트 상세

### 3-1. 탭 바

| 탭 | id | 설명 |
|----|----|------|
| **조건 검색** | `search` | 필터 기반 종목 검색, 테이블/히트맵 뷰 |
| **테마 탐색** | `theme` | 섹터별 카드 그리드 |

- 탭 전환 시 `activeTab` 상태 변경
- 조건 검색 탭에서만 `GET /api/scanner` 호출 (`enabled` 조건)

### 3-2. ScreeningFilters (조건 검색 필터)

조건 검색 탭에서 표시되는 필터 폼.

| 필터 | 타입 | 설명 | 기본값 |
|------|------|------|--------|
| **종목 검색** | text input | 종목명 또는 티커 코드 (부분 일치) | 빈 문자열 |
| **주간수익률 최소** | number input | 최소 주간수익률 (%) | - |
| **주간수익률 최대** | number input | 최대 주간수익률 (%) | - |
| **외국인 순매수** | checkbox | 외국인 순매수 종목만 | false |
| **기관 순매수** | checkbox | 기관 순매수 종목만 | false |

**동작:**
- 검색: Enter 또는 [검색] 버튼 클릭 시 `onFilterChange({ q })` 호출
- 주간수익률: onBlur 또는 Enter 시 `applyNumberFilter` → `parseFloat` 후 적용, NaN 무시
- 초기화: [초기화] 클릭 시 모든 필터 DEFAULT_FILTERS로 리셋
- 하단 우측: `lastUpdated` (아이템 중 가장 최신 `catalog_updated_at`) 표시

**참고:** `type`(ETF/STOCK/ALL), `sector`는 API 지원하지만 현재 UI에서 직접 변경 불가. `sector`는 테마 탐색에서 섹터 카드 클릭 시 조건 검색 탭으로 전환하며 적용.

### 3-3. 기본 필터값 (DEFAULT_FILTERS)

| 키 | 기본값 |
|----|--------|
| `q` | undefined |
| `type` | `'ETF'` |
| `sector` | undefined |
| `min_weekly_return` | undefined |
| `max_weekly_return` | undefined |
| `foreign_net_positive` | undefined |
| `institutional_net_positive` | undefined |
| `sort_by` | `'weekly_return'` |
| `sort_dir` | `'desc'` |
| `page` | 1 |
| `page_size` | 20 |

### 3-4. 정렬 옵션 (SORT_OPTIONS)

| value | label |
|-------|-------|
| `weekly_return` | 주간수익률 |
| `daily_change_pct` | 등락률 |
| `volume` | 거래량 |
| `close_price` | 현재가 |
| `foreign_net` | 외국인 |
| `institutional_net` | 기관 |
| `name` | 종목명 |

- 드롭다운으로 `sort_by` 선택, 방향 버튼으로 `sort_dir` 전환 (asc/desc)
- 정렬 변경 시 `page: 1`로 초기화

### 3-5. 뷰 모드

| 모드 | 컴포넌트 | page_size |
|------|----------|-----------|
| **테이블** | ScreeningTable | filters.page_size (20) |
| **히트맵** | ScreeningHeatmap | 50 (고정) |

- 토글 버튼으로 전환
- 히트맵 모드에서는 `effectivePageSize=50`으로 API 호출

### 3-6. ScreeningTable (테이블 뷰)

종목 목록을 테이블 형태로 표시.

**컬럼:**

| 키 | 라벨 | 정렬 | 정렬 |
|----|------|------|------|
| `name` | 종목명 | ✓ | - |
| `close_price` | 현재가 | ✓ | 우측 정렬 |
| `daily_change_pct` | 등락률 | ✓ | 우측 정렬 |
| `volume` | 거래량 | ✓ | 우측 정렬 |
| `weekly_return` | 주간수익률 | ✓ | 우측 정렬 |
| `foreign_net` | 외국인 | ✓ | 우측 정렬 |
| `institutional_net` | 기관 | ✓ | 우측 정렬 |

**인터랙션:**
- **등록 종목** (`is_registered=true`): 종목명 클릭 → `/etf/:ticker` 이동
- **미등록 종목**: 종목명 클릭 → `/settings` 이동, state에 `addStock: { ticker, name, type, theme }` 전달하여 종목 추가 폼 프리필

**페이지네이션:**
- 총 건수, 현재 범위 표시
- 이전/다음, 최대 5개 페이지 버튼 (슬라이딩 윈도우)
- `totalPages > 1`일 때만 표시

**색상 규칙** (한국 금융 관례):
- 상승 (양수): 빨간색
- 하락 (음수): 파란색
- 보합 (0): 회색

### 3-7. ScreeningHeatmap (히트맵 뷰)

Treemap으로 종목을 시각화. `recharts` Treemap 사용.

| 속성 | 설명 |
|------|------|
| **셀 크기** | `log10(volume)` 기반, 최소 2 보장 |
| **셀 색상** | 주간수익률 기반 (한국식: 빨강=상승, 파랑=하락) |
| **테두리** | 등록 종목은 시안(#00e5ff) 테두리 강조 |
| **툴팁** | 종목명, 현재가, 주간/일간 수익률, 외국인/기관 순매수 |

**색상 매핑 (주간수익률):**

| 범위 | 색상 |
|------|------|
| +5% 이상 | #991b1b (진한 빨강) |
| +3% ~ +5% | #dc2626 |
| +1% ~ +3% | #ef4444 |
| 0% ~ +1% | #fca5a5 (연한 빨강) |
| -1% ~ 0% | #93c5fd (연한 파랑) |
| -3% ~ -1% | #3b82f6 |
| -5% ~ -3% | #1d4ed8 |
| -5% 이하 | #1e3a8a (진한 파랑) |

**반응형:** 셀 크기에 따라 표시 항목 조절
- `width>50, height>25`: 종목명
- `width>60, height>45`: 현재가
- `width>40, height>20`: 주간수익률
- `width>80, height>60`: 일간 등락률

**인터랙션:**
- 셀 클릭 → 등록 종목이면 ETF 상세, 미등록이면 설정(종목 추가)으로 이동
- 히트맵 모드에서도 하단에 이전/다음 페이지네이션 제공

### 3-8. ThemeExplorer (테마 탐색)

섹터별 카드 그리드.

| 표시 항목 | 설명 |
|----------|------|
| **섹터명** | `theme.sector` |
| **종목 수** | `theme.count` |
| **평균 주간수익률** | `theme.avg_weekly_return` |
| **Top 3 종목** | `theme.top_performers` (주간수익률 기준) |

**인터랙션:**
- 카드 클릭 → `onSectorClick(sector)` 호출
  - 조건 검색 탭으로 전환
  - `filters`를 `{ ...DEFAULT_FILTERS, sector }`로 설정하여 해당 섹터만 검색

**데이터 없음:**
- 테마가 없으면 "테마 데이터가 없습니다. 데이터를 먼저 수집해주세요." + [데이터 수집] 버튼

### 3-9. 데이터 수집

| 버튼 | 동작 |
|------|------|
| **데이터 수집** | `POST /api/scanner/collect-data` 호출, 수집 중이면 disabled |
| **중지** | `POST /api/scanner/cancel-collect` 호출 |

**진행률 배너:**
- `isCollecting && progress`일 때 표시
- `progress.message`, `progress.percent` (퍼센트 바), [중지] 버튼
- `progress.percent`가 있으면 숫자 표시

**진행 상태 처리:**
- `completed`: Toast 성공, scanner/themes/recommendations 캐시 무효화
- `cancelled`: Toast 정보
- `error`: Toast 에러
- `idle`: UI 정리

---

## 4. API 요청 파라미터

### GET /api/scanner

| 파라미터 | 타입 | 필수 | 설명 |
|----------|------|------|------|
| `q` | string | - | 종목명/코드 검색 (부분 일치) |
| `type` | string | - | ETF / STOCK / ALL (기본 ETF) |
| `sector` | string | - | 섹터 필터 |
| `min_weekly_return` | float | - | 최소 주간수익률 |
| `max_weekly_return` | float | - | 최대 주간수익률 |
| `foreign_net_positive` | bool | - | 외국인 순매수만 |
| `institutional_net_positive` | bool | - | 기관 순매수만 |
| `sort_by` | string | - | weekly_return, daily_change_pct, volume 등 |
| `sort_dir` | string | - | asc / desc |
| `page` | int | - | 페이지 (기본 1) |
| `page_size` | int | - | 1~50 (기본 20, 히트맵 시 50) |

### 응답 (ScreeningResponse)

```json
{
  "items": [
    {
      "ticker": "379810",
      "name": "KODEX 2차전지테마",
      "type": "ETF",
      "close_price": 12345,
      "daily_change_pct": 1.2,
      "volume": 1000000,
      "weekly_return": 3.5,
      "foreign_net": 12345,
      "institutional_net": -5000,
      "catalog_updated_at": "2025-02-12T00:00:00",
      "is_registered": true
    }
  ],
  "total": 150,
  "page": 1,
  "page_size": 20
}
```

---

## 5. 상태 관리

| 상태 | 저장소 | 용도 |
|------|--------|------|
| `activeTab` | useState | 'search' \| 'theme' |
| `viewMode` | useState | 'table' \| 'heatmap' |
| `filters` | useState | 검색 필터·정렬·페이지 |
| `isCollecting` | useState | 수집 진행 여부 |
| `progress` | useState | 수집 진행률 (message, percent) |
| `pollingRef` | useRef | setInterval ID (클린업용) |
| screening 데이터 | React Query | 조건 검색 결과 |
| themes 데이터 | React Query | 테마 그룹 |

---

## 6. UI 상태별 처리

| 상태 | 표시 |
|------|------|
| **로딩** | LoadingIndicator "검색 중..." |
| **에러** | 빨간 배경 박스 + 에러 메시지 |
| **빈 결과** | "검색 결과가 없습니다. 필터를 조정해보세요." (테이블) / "표시할 데이터가 없습니다." (히트맵) |
| **정상** | 테이블 또는 히트맵 + 페이지네이션 |

---

## 7. 관련 파일

### 프론트엔드

| 파일 | 역할 |
|------|------|
| `pages/Screening.jsx` | 페이지 컨테이너, 탭·필터·수집·쿼리 로직 |
| `components/screening/ScreeningFilters.jsx` | 조건 검색 필터 폼 |
| `components/screening/ScreeningTable.jsx` | 테이블 뷰 |
| `components/screening/ScreeningHeatmap.jsx` | Treemap 히트맵 뷰 |
| `components/screening/ThemeExplorer.jsx` | 테마 탐색 카드 그리드 |
| `services/api.js` | scannerApi (search, getThemes, collectData, getCollectProgress, cancelCollect) |

### 백엔드

| 파일 | API |
|------|-----|
| `routers/scanner.py` | GET /api/scanner, GET /api/scanner/themes, GET /api/scanner/recommendations, POST /api/scanner/collect-data, GET /api/scanner/collect-progress, POST /api/scanner/cancel-collect |

### 데이터 소스

- `stock_catalog` 테이블: 네이버 금융에서 수집한 ETF/주식 메타데이터 및 가격·수급
- `catalog_updated_at IS NOT NULL`인 종목만 검색 대상
