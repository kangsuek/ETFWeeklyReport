# 설정 기능 명세서

설정 페이지는 **일반 설정, 종목 관리, API 키, 데이터 관리**를 제공하는 페이지로, `/settings` 경로에서 접근한다.

---

## 1. 화면 구성

```
┌──────────────────────────────────────────────────────────────────┐
│  PageHeader ("설정" / "종목 관리 및 환경 설정")                     │
├──────────────────────────────────────────────────────────────────┤
│  1. GeneralSettingsPanel — 일반 설정                               │
│     테마, 자동 새로고침, 기본 날짜 범위, 표시 옵션                  │
├──────────────────────────────────────────────────────────────────┤
│  2. TickerManagementPanel — 종목 관리                             │
│     종목 테이블/카드, 추가·수정·삭제·순서 변경                      │
├──────────────────────────────────────────────────────────────────┤
│  3. ApiKeysPanel — API 키 설정                                     │
│     네이버 Client ID / Client Secret                              │
├──────────────────────────────────────────────────────────────────┤
│  4. DataManagementPanel — 데이터 관리                              │
│     통계, 수집, DB 초기화                                          │
└──────────────────────────────────────────────────────────────────┘
```

**라우트 state:** `location.state?.addStock` — 스크리닝/비교 등에서 종목 추가 요청 시 프리필 데이터 전달

---

## 2. GeneralSettingsPanel (일반 설정)

### 2-1. 저장소

- **SettingsContext** → LocalStorage (`app_settings`)
- `updateSettings(key, value)` — 점 표기법 지원 (예: `autoRefresh.enabled`)
- `resetSettings()` — 일반 설정 + cardOrder 초기화 (종목·API·데이터 유지)

### 2-2. 설정 항목

| 항목 | 키 | 옵션 | 기본값 |
|------|-----|------|--------|
| **테마** | theme | light, dark, system | light |
| **자동 새로고침** | autoRefresh.enabled | 토글 | true |
| **새로고침 간격** | autoRefresh.interval | 30초, 1분, 5분, 10분 | 30000 (30초) |
| **기본 날짜 범위** | defaultDateRange | 7D, 1M, 3M | 1M |
| **거래량 표시** | display.showVolume | 토글 | true |
| **매매 동향 표시** | display.showTradingFlow | 토글 | true |

### 2-3. 테마 동작

- `applyTheme()`: document.documentElement에 `dark` 클래스 추가/제거
- `system`: `prefers-color-scheme` 미디어 쿼리 반영
- `mediaQuery.addEventListener('change')`로 시스템 테마 변경 감지

### 2-4. 초기화

- [일반 설정 초기화] 클릭 시 confirm → `resetSettings()`
- 초기화 범위: 테마, 자동 갱신, 기본 날짜 범위, 표시 옵션, 대시보드 카드 순서

---

## 3. TickerManagementPanel (종목 관리)

### 3-1. 데이터 흐름

| API | 용도 |
|-----|------|
| `GET /api/settings/stocks` | 종목 목록 (stocks.json) |
| `POST /api/settings/stocks` | 종목 추가 |
| `PUT /api/settings/stocks/{ticker}` | 종목 수정 |
| `DELETE /api/settings/stocks/{ticker}` | 종목 삭제 |
| `POST /api/settings/stocks/reorder` | 순서 변경 (Body: tickers 배열) |

### 3-2. prefillStock

- 스크리닝/비교에서 `/settings`로 이동 시 `state.addStock: { ticker, name, type, theme }` 전달
- `useEffect`로 `prefillStock` 감지 시 TickerForm 자동 오픈 (create 모드)

### 3-3. 테이블/카드 뷰

**데스크톱 (md 이상):** 테이블  
**모바일:** 카드

| 컬럼/표시 | 설명 |
|----------|------|
| 순서 | 위/아래 이동 버튼 |
| 티커 | 종목 코드 |
| 종목명 | 이름 |
| 타입 | ETF/STOCK 뱃지 |
| 테마 | 테마명 |
| 매입가 | formatPrice |
| 수량 | formatNumber |
| 작업 | 수정, 삭제 |

### 3-4. 순서 변경

- 위/아래 버튼으로 행 이동
- Optimistic Update: `setQueryData`로 즉시 반영 후 `reorderStocks(tickers)` 호출
- 이동한 종목 1.5초간 하이라이트 (animate-pulse, ring)

### 3-5. TickerForm (모달)

**모드:** create | edit

**필드:**

| 필드 | 필수 | 타입 | 비고 |
|------|------|------|------|
| 티커 코드 | ✓ | text | 자동완성, 6자리 시 자동 입력 (800ms debounce) |
| 종목명 | ✓ | text | 자동완성 |
| 타입 | ✓ | select | ALL, ETF, STOCK |
| 테마 | - | text | 예: 2차전지, 반도체 |
| 구매일 | - | date | 1900–2099, 연도 4자리 |
| 매입 평균 금액 | - | text | 콤마 포맷, 소수점 허용 |
| 보유 수량 | - | text | 정수, 콤마 포맷 |
| 뉴스 검색 키워드 | - | text | |
| 관련 키워드 | - | text | 쉼표 구분 → 배열 |

**자동완성:**
- `GET /api/settings/stocks/search?q=...&type=...`
- 최소 2자 입력 시 검색 (MIN_SEARCH_LENGTH)
- 티커/종목명 포커스 시 searchField 설정, 선택 시 ticker/name/type 자동 입력

**네이버 자동 입력:**
- `GET /api/settings/stocks/{ticker}/validate` — 네이버 금융 스크래핑
- 티커 6자리 입력 + name 비어 있을 때 800ms 후 자동 호출
- 수동 [네이버에서 자동 입력] 버튼

### 3-6. TickerDeleteConfirm (모달)

- 삭제 시 함께 제거: stocks.json, 가격, 뉴스, 매매동향
- onConfirm → `deleteStock(ticker)` 후 삭제 건수 alert

---

## 4. ApiKeysPanel (API 키 설정)

### 4-1. API

| API | 용도 |
|-----|------|
| `GET /api/settings/api-keys` | 조회 (마스킹된 값) |
| `PUT /api/settings/api-keys` | 저장 |

### 4-2. UI

- **조회 모드:** Client ID / Client Secret 마스킹 표시, [수정] 버튼
- **편집 모드:** 빈 입력 필드, [저장] [취소]
- `*` 포함된 값은 변경 없음으로 간주 → payload에서 제외
- 설정됨/미설정 뱃지

### 4-3. 안내

- 네이버 개발자 센터 링크
- 뉴스 수집에 필요한 API 키 안내

---

## 5. DataManagementPanel (데이터 관리)

### 5-1. 데이터 통계

`GET /api/data/stats` — 30초마다 refetch

| 항목 | 키 |
|------|-----|
| 종목 수 | etfs |
| 가격 레코드 | prices |
| 매매 동향 | trading_flow |
| 뉴스 | news |
| 마지막 수집 | last_collection |
| DB 크기 | database_size_mb |
| 종목 카탈로그 | stock_catalog (있으면) |

### 5-2. 종목 목록 수집

- `POST /api/settings/ticker-catalog/collect`
- 확인 모달 → 수집 시작 → `getTickerCatalogProgress` 2초 폴링
- StepProgressBar: 코스피 → 코스닥 → ETF → 저장
- 소요 시간: 약 5–10분

### 5-3. 전체 데이터 수집

- 수집 기간: 1일, 7일, 10일, 30일, 90일, 180일, 365일 (기본 90일)
- `POST /api/data/collect-all?days=N`
- 확인 모달 → `getCollectProgress` 2초 폴링
- 소요 시간: `collectionDays * 6`초 단위로 표시

### 5-4. 데이터베이스 초기화

- `DELETE /api/data/reset`
- 확인 모달 (삭제 대상: 가격, 뉴스, 매매동향, 수집상태, 분봉)
- 성공 시 `queryClient.clear()` + 1초 후 `location.reload()`

---

## 6. 관련 API 요약

### Settings

| 메서드 | 경로 | 설명 |
|--------|------|------|
| GET | /api/settings/stocks | 종목 목록 |
| POST | /api/settings/stocks | 종목 추가 |
| PUT | /api/settings/stocks/{ticker} | 종목 수정 |
| DELETE | /api/settings/stocks/{ticker} | 종목 삭제 |
| GET | /api/settings/stocks/{ticker}/validate | 티커 검증 (네이버) |
| GET | /api/settings/stocks/search | 종목 검색 (q, type) |
| POST | /api/settings/stocks/reorder | 순서 변경 |
| GET | /api/settings/api-keys | API 키 조회 |
| PUT | /api/settings/api-keys | API 키 저장 |
| POST | /api/settings/ticker-catalog/collect | 종목 목록 수집 |
| GET | /api/settings/ticker-catalog/collect-progress | 수집 진행률 |

### Data

| 메서드 | 경로 | 설명 |
|--------|------|------|
| GET | /api/data/stats | DB 통계 |
| POST | /api/data/collect-all | 전체 수집 |
| GET | /api/data/collect-progress | 수집 진행률 |
| DELETE | /api/data/reset | DB 초기화 |

---

## 7. 관련 파일

### 프론트엔드

| 파일 | 역할 |
|------|------|
| `pages/Settings.jsx` | 페이지 컨테이너 |
| `components/settings/GeneralSettingsPanel.jsx` | 일반 설정 |
| `components/settings/TickerManagementPanel.jsx` | 종목 관리 |
| `components/settings/TickerForm.jsx` | 종목 추가/수정 모달 |
| `components/settings/TickerDeleteConfirm.jsx` | 삭제 확인 모달 |
| `components/settings/ApiKeysPanel.jsx` | API 키 |
| `components/settings/DataManagementPanel.jsx` | 데이터 관리 |
| `contexts/SettingsContext.jsx` | 설정 상태·LocalStorage |

### 백엔드

| 파일 | API |
|------|-----|
| `routers/settings.py` | /api/settings/* |
| `routers/data.py` | /api/data/stats, collect-all, reset 등 |
