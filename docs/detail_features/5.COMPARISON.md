# 종목 비교 기능 명세서

종목 비교는 **등록된 ETF/주식 간 성과·위험·상관관계**를 시각화하는 페이지로, `/compare` 경로에서 접근한다.

---

## 1. 화면 구성

```
┌──────────────────────────────────────────────────────────────────┐
│  PageHeader ("ETF Comparison" / "종목간 비교 분석 - 투자 시뮬레이션, 위험·수익, 상관관계, 가격 추이") │
├──────────────────────────────────────────────────────────────────┤
│  TickerSelector — 종목 선택 (체크박스 그리드, 2~20개)            │
│  선택 뱃지 | [전체 해제] | 종목 카드 그리드                      │
├──────────────────────────────────────────────────────────────────┤
│  DateRangeSelector (종목 2개 이상 선택 시 표시)                    │
│  7일 | 1개월 | 3개월 | 6개월 | YTD | 1년 | 커스텀                  │
├──────────────────────────────────────────────────────────────────┤
│  ※ 비교 결과 (종목 2~20개 선택 시):                               │
│  1. InvestmentSimulation — 투자 시뮬레이션 카드 + 한줄 요약       │
│  2. RiskReturnScatter — 위험-수익 산점도                          │
│  3. CorrelationHeatmap — 상관관계 히트맵                         │
│  4. NormalizedPriceChart — 정규화 가격 추이                      │
│  5. ComparisonTable — 성과 비교 테이블                           │
├──────────────────────────────────────────────────────────────────┤
│  ※ 안내 메시지 (1개만 선택 또는 20개 초과 시)                     │
└──────────────────────────────────────────────────────────────────┘
```

---

## 2. 데이터 흐름

### 사용하는 API

| 순서 | API | 용도 | 캐시 정책 |
|------|-----|------|----------|
| 1 | `GET /api/etfs` | 전체 종목 목록 조회 (TickerSelector용) | staleTime 5분 |
| 2 | `GET /api/etfs/compare` | 종목 비교 데이터 (정규화 가격, 통계, 상관행렬) | staleTime 1분 |

### 요청 순서

1. 페이지 진입 시 → `GET /api/etfs` (종목 목록)
2. 종목 2개 이상 선택 시 → `GET /api/etfs/compare` (`tickers`, `start_date`, `end_date`)
3. 종목/날짜 변경 시 → 동일 API 재호출 (`enabled: selectedTickers.length >= 2`)

### 응답 검증

- `normalized_prices`, `statistics`가 모두 있어야 유효
- 형식이 다르면 `Invalid response format from server` 에러 throw

---

## 3. 컴포넌트 상세

### 3-1. TickerSelector (종목 선택)

비교할 종목을 다중 선택한다.

| 속성 | 설명 |
|------|------|
| **최소 선택** | 2개 |
| **최대 선택** | `COMPARE_MAX_TICKERS` (20개) |
| **선택 UI** | 체크박스 그리드 (1열 → 2열(sm) → 3열(lg)) |
| **선택 뱃지** | 선택된 종목명 + × 버튼으로 해제 |

**동작:**
- 체크박스 토글 시 `onSelectionChange(newSelection)` 호출
- 최대 개수 도달 시 미선택 종목은 disabled (선택 불가)
- [전체 해제] 클릭 시 선택 초기화
- 선택 상태: `N개 선택됨` (canCompare면 녹색, 아니면 회색)
- 경고: `selected < 2` → "최소 2개 이상 선택하세요", `selected > max` → "최대 N개까지 선택 가능합니다"

**표시 정보:** 종목명, 티커, 테마

### 3-2. DateRangeSelector (날짜 범위)

비교 기간을 선택한다. `canCompare`(2~20개 선택)일 때만 표시.

| 프리셋 | 값 | 설명 |
|--------|-----|------|
| 7일 | 7d | 오늘 기준 7일 전 ~ 오늘 |
| 1개월 | 1m | 1개월 전 ~ 오늘 (기본값) |
| 3개월 | 3m | 3개월 전 ~ 오늘 |
| 6개월 | 6m | 6개월 전 ~ 오늘 |
| YTD | ytd | 올해 1월 1일 ~ 오늘 |
| 1년 | 1y | 1년 전 ~ 오늘 |
| 커스텀 | custom | 시작일·종료일 직접 입력 후 [적용] |

**검증 (커스텀):**
- `validateDateRange`: 시작일 ≤ 종료일, 미래 날짜 불가, 최대 365일

**초기값:** Comparison 페이지에서 `subMonths(today, 1)` (1개월)로 설정

### 3-3. InvestmentSimulation (투자 시뮬레이션)

기준 100만원 투자 시 종목별 예상 수익을 표시한다.

| 항목 | 설명 |
|------|------|
| **기준 투자금** | 100만원 (INVESTMENT_AMOUNT 고정) |
| **평가액** | `1000000 * (1 + period_return/100)` |
| **정렬** | 기간 수익률 높은 순 |

**한줄 요약:**
- **최고 수익:** `period_return` 최대 종목 (붉은색 강조)
- **가장 안정적:** `volatility` 최소 종목 (녹색 강조)

**카드 표시:**
- 투자금 → 평가액 (화살표)
- 수익/손실 금액 + 수익률
- 1등 배지 (수익률 1위 종목)

**하단:** "과거 기간 수익률 기반, 미래 수익 보장하지 않음" + [상세 시뮬레이션] 링크 → `/simulation`

### 3-4. RiskReturnScatter (위험-수익 산점도)

recharts ScatterChart 기반.

| 축 | 데이터 | 설명 |
|----|--------|------|
| **X축** | volatility | 변동성 (위험) |
| **Y축** | period_return | 기간 수익률 (수익) |

**시각 요소:**
- 종목별 색상: `CHART_COLOR_PALETTE` 순환
- 평균 기준선: X·Y 평균값으로 사분면 구분 (점선)
- 툴팁: 종목명, 수익률, 변동성

**사분면 설명:**
- ◀ ▲: 저위험·고수익 (이상적)
- ▶ ▲: 고위험·고수익
- ◀ ▼: 저위험·저수익
- ▶ ▼: 고위험·저수익 (비효율적)

### 3-5. CorrelationHeatmap (상관관계 히트맵)

N×N CSS Grid 테이블.

| 구조 | 설명 |
|------|------|
| **행/열 헤더** | 종목명 (tickerInfo 기반) |
| **셀** | 상관계수 (0~1), `getCorrelationColor` 그라데이션 |
| **대각선** | 1.0 (자기 자신), ring 강조 |

**색상 규칙:**
- 0 (독립적): 파랑
- 0.5: 중간 (흰/회색)
- 1 (동일): 빨강

**설명:** "1에 가까우면 함께 움직이는 종목, 0에 가까우면 독립적 → 분산 투자에 유리"

### 3-6. NormalizedPriceChart (정규화 가격 추이)

시작일 = 100으로 정규화된 라인 차트.

| 데이터 구조 | `normalized_prices.dates`, `normalized_prices.data[ticker]` |
|-------------|-------------------------------------------------------------|
| **라인** | 종목별 색상 (CHART_COLOR_PALETTE) |
| **정렬** | 수익률 높은 순 (범례·라인 순서) |
| **툴팁** | 날짜, 종목별 정규화 가격, 변화율 (대비 100) |
| **범례** | 종목명, 최종 변화율 표시 |

**X축:** M/d 포맷

### 3-7. ComparisonTable (성과 비교 테이블)

| 컬럼 | 키 | 포맷 | 비고 |
|------|-----|------|------|
| 종목명 | - | name, ticker | 정렬 불가 |
| 기간 수익률 | period_return | formatPercent | 정렬 가능 |
| 연환산 수익률 | annualized_return | formatPercent, N/A (3개월 미만) | 툴팁 |
| 변동성 | volatility | formatPercent | 낮을수록 좋음 |
| 최대 낙폭 | max_drawdown | formatPercent | 음수 |
| 샤프 비율 | sharpe_ratio | formatNumber | 1+ 양호, 툴팁 |

**정렬:** 컬럼 클릭 시 오름차순/내림차순 전환 (기본: period_return 내림차순)

**최고 성과 강조:** 각 컬럼별 최고값에 배경색 + ⭐ 표시 (변동성은 최소값이 최고)

**반응형:** 데스크톱=테이블, 모바일=카드 레이아웃

---

## 4. API 요청·응답

### GET /api/etfs/compare

| 파라미터 | 타입 | 필수 | 설명 |
|----------|------|------|------|
| `tickers` | string | ✓ | 쉼표 구분 (2~20개) |
| `start_date` | date | - | 기본 30일 전 |
| `end_date` | date | - | 기본 오늘 |

**응답:**

```json
{
  "normalized_prices": {
    "dates": ["2025-01-01", ...],
    "data": {
      "487240": [100, 102.5, ...],
      "466920": [100, 101.2, ...]
    }
  },
  "statistics": {
    "487240": {
      "period_return": 12.5,
      "annualized_return": 45.2,
      "volatility": 25.3,
      "max_drawdown": -8.2,
      "sharpe_ratio": 1.67,
      "data_points": 30
    }
  },
  "correlation_matrix": {
    "tickers": ["487240", "466920", ...],
    "matrix": [[1.0, 0.85, ...], ...]
  }
}
```

---

## 5. 상태 관리

| 상태 | 저장소 | 용도 |
|------|--------|------|
| `selectedTickers` | useState | 선택된 티커 배열 |
| `dateRange` | useState | { start, end } |
| `tickers` | React Query | 전체 종목 목록 |
| `comparisonData` | React Query | 비교 API 응답 |
| `tickerInfoMap` | useMemo | ticker → { name, ticker, theme } 맵 |

**파생값:**
- `canCompare` = `selectedTickers.length >= 2 && selectedTickers.length <= COMPARE_MAX_TICKERS`
- `showResults` = `canCompare && comparisonData`

---

## 6. UI 상태별 처리

| 상태 | 표시 |
|------|------|
| **종목 목록 로딩** | 스피너 + "종목 목록 로딩 중..." |
| **1개 선택** | 파란 안내: "종목을 더 선택해주세요" |
| **20개 초과** | 파란 안내: "최대 20개까지 선택 가능합니다" |
| **비교 데이터 로딩** | 스피너 + "비교 데이터 로딩 중... (N개 종목)" |
| **데이터 없음** | 노란 경고: "선택한 종목의 데이터를 불러올 수 없습니다. 날짜 범위를 조정하거나..." |
| **에러** | 빨간 경고: 에러 메시지 |
| **정상** | 5개 섹션(시뮬레이션, 산점도, 히트맵, 차트, 테이블) 표시 |

---

## 7. 관련 파일

### 프론트엔드

| 파일 | 역할 |
|------|------|
| `pages/Comparison.jsx` | 페이지 컨테이너, 종목/날짜·쿼리·결과 렌더링 |
| `components/comparison/TickerSelector.jsx` | 종목 다중 선택 |
| `components/charts/DateRangeSelector.jsx` | 날짜 범위 선택 |
| `components/comparison/InvestmentSimulation.jsx` | 투자 시뮬레이션 카드 |
| `components/comparison/RiskReturnScatter.jsx` | 위험-수익 산점도 |
| `components/comparison/CorrelationHeatmap.jsx` | 상관관계 히트맵 |
| `components/comparison/NormalizedPriceChart.jsx` | 정규화 가격 차트 |
| `components/comparison/ComparisonTable.jsx` | 성과 비교 테이블 |
| `services/api.js` | etfApi.compare, apiService.compareETFs |
| `constants.js` | COMPARE_MAX_TICKERS (20), CACHE_STALE_TIME_SLOW |
| `utils/validation.js` | validateDateRange |

### 백엔드

| 파일 | API |
|------|-----|
| `routers/etfs.py` | GET /api/etfs/compare |
| `services/comparison_service.py` | ComparisonService.get_comparison_data |
