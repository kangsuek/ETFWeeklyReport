# 종목 상세 페이지 기능 명세서

종목 상세 페이지(`/etf/:ticker`)는 개별 종목의 **인사이트, 가격, 차트, 기술지표, 분봉, 뉴스, 알림**을 통합 제공하는 핵심 페이지이다.

---

## 1. 화면 구성

페이지는 **기본 보기**(초보자용)와 **고급 분석**(전문 투자자용) 두 영역으로 나뉜다.

```
┌──────────────────────────────────────────────┐
│  ETFHeader (Sticky) — 종목명, 티커, 테마       │
├══════════════════════════════════════════════╡
│  ── 기본 보기 ──                               │
│                                              │
│  1. InsightSummary (핵심 포인트 + 리스크 요약)  │
│  2. StrategySummary (투자 전략 — 단기/중기/장기)│
│  3. 종목 정보 + 최근 가격 + 투자 현황           │
│  4. DateRangeSelector (7일/1개월/3개월)         │
│     ETFCharts:                                │
│     ├─ PriceChart (캔들+거래량)                │
│     ├─ TradingFlowChart (개인/기관/외국인)      │
│     ├─ RSI / MACD 기술지표                     │
│     └─ 지지선/저항선                            │
│  5. 분봉 차트 (IntradayChart)                  │
│     + PriceTargetPanel (알림 설정)              │
│  6. 최근 뉴스 (NewsTimeline)                   │
│                                              │
│  ── 고급 분석 ──                               │
│                                              │
│  7. 가격 데이터 테이블 (접기/펼치기)             │
└──────────────────────────────────────────────┘
```

---

## 2. 데이터 흐름

### 사용하는 API

| 우선순위 | API | 용도 | 캐시 정책 |
|---------|-----|------|----------|
| 1순위 | `GET /api/etfs/{ticker}` | 종목 기본 정보 | staleTime 5분 |
| 1순위 | `GET /api/etfs/{ticker}/prices` | 가격 데이터 (날짜 범위) | staleTime 30초, 마운트 시 재조회 |
| 1순위 | `GET /api/etfs/{ticker}/trading-flow` | 매매 동향 (날짜 범위) | staleTime 30초, 마운트 시 재조회 |
| 2순위 | `GET /api/etfs/{ticker}/insights` | 인사이트·전략 | staleTime 2분 |
| 3순위 | `GET /api/news/{ticker}` | 뉴스 (최근 7일, 10건) | staleTime 5분 |
| 별도 | `GET /api/etfs/{ticker}/intraday` | 분봉 데이터 | 장중 10초 / 장외 30초 |
| 별도 | `GET /api/etfs/{ticker}/prices` (확장) | RSI/MACD용 60일 추가 데이터 | staleTime 30초 |
| 별도 | `GET /api/alerts/{ticker}` | 알림 규칙 (목표가) | staleTime 30초 |

### 요청 전략

- 1~3순위 API는 `useQueries`로 **병렬 호출** (초기 렌더 최적화)
- 분봉은 기본 정보 로드 후 별도 `useQuery`로 요청 (`enabled: !!etf`)
- 기술지표용 확장 가격 데이터는 RSI/MACD 토글 켜진 경우에만 요청
- 날짜 범위 변경 시 가격·매매동향만 재요청 (queryKey에 날짜 포함)

---

## 3. 컴포넌트 상세

### 3-1. ETFHeader (Sticky 헤더)

- 스크롤 시에도 **상단 고정** (`sticky top-0 z-50`)
- 종목명 (h1), 티커·테마 표시
- 다크모드 대응

▶ 상세: [3-1.ETFHeader.md](./3-1.ETFHeader.md)

### 3-2. InsightSummary (투자 인사이트 요약)

가격·매매동향 데이터를 분석하여 자동 생성되는 인사이트.

| 섹션 | 내용 | 최대 |
|------|------|------|
| **핵심 포인트** | 매매동향, 추세, 변동성 분석 | 4개 |
| **리스크 요약** | 위험 요소 알림 | 3개 |

- 인사이트 타입: `positive` (녹색), `warning` (주황), `neutral` (회색)
- 프론트엔드 룰 기반 (`utils/insights.js`의 `generateAllInsights()`)
- 데이터 부족 시 자동 숨김

▶ 상세: [3-2.InsightSummary.md](./3-2.InsightSummary.md)

### 3-3. StrategySummary (투자 전략)

백엔드 인사이트 API 기반 전략 제안.

| 전략 유형 | 뱃지 색상 |
|----------|----------|
| 비중확대 | 녹색 |
| 보유 | 파란색 |
| 관망 | 회색 |
| 비중축소 | 빨간색 |

- 기간별 전략: 날짜 범위에 연동 (7d→1w, 1m→1m, 3m→3m)
- 로딩/에러 상태 개별 처리

▶ 상세: [3-3.StrategySummary.md](./3-3.StrategySummary.md)

### 3-4. 종목 정보 + 최근 가격 카드

**종목 정보** (2/3 너비):
- 티커, 타입 (ETF/STOCK 뱃지), 테마, 구매일

**최근 가격** (1/3 너비):
- 기준일, 종가, 전일 대비 등락률
- 투자 종목 한정: 매입가, 매입 대비 수익률, 보유 수량, 총 투자 금액
- **평가 금액** (종가 × 수량) 및 **현재 손익** (평가 - 투자) 카드

▶ 상세: [3-4.StockInfoPriceCard.md](./3-4.StockInfoPriceCard.md)

### 3-5. 날짜 범위 선택 (DateRangeSelector)

| 범위 | 표시 |
|------|------|
| 7d | 7일 |
| 1m | 1개월 |
| 3m | 3개월 |

- 설정 페이지의 기본 날짜 범위와 연동 (`settings.defaultDateRange`)
- 사용자가 수동 변경하면 설정값 무시 (`userModifiedRef`)
- 변경 시 가격·매매동향 queryKey 갱신 → 자동 재요청

▶ 상세: [3-5.DateRangeSelector.md](./3-5.DateRangeSelector.md)

### 3-6. ETFCharts (차트 영역)

4개 차트를 수직 배치.

| 차트 | 컴포넌트 | 조건 |
|------|---------|------|
| **가격 차트** | `PriceChart` | `settings.display.showVolume` (기본 켜짐) |
| **매매 동향** | `TradingFlowChart` | `settings.display.showTradingFlow` (기본 켜짐) |
| **RSI** | `RSIChart` | `showRSI` 토글 (기본 켜짐) |
| **MACD** | `MACDChart` | `showMACD` 토글 (기본 켜짐) |

**추가 기능**:
- 가격 차트에 **매입가 수평선** 표시 (투자 종목)
- **지지선/저항선** 자동 계산 및 표시 (`calculateSupportResistance`)
- 가격 차트 ↔ 매매동향 차트 **스크롤 동기화** (ref 기반, `requestAnimationFrame`으로 무한 루프 방지)

**기술지표 데이터**:
- RSI/MACD 계산에는 선행 60일 데이터 필요 → 확장 날짜 범위로 별도 API 호출
- RSI: 14일 기간 (`calculateRSI`)
- MACD: 12/26/9 설정 (`calculateMACD`)

▶ 상세: [3-6.ETFCharts.md](./3-6.ETFCharts.md)

### 3-7. 분봉 차트 (IntradayChart)

당일 시간별 체결 데이터를 시각화.

| 항목 | 장중 (09:00~15:30, 평일) | 장외 |
|------|------|------|
| 자동 갱신 | 20초 간격 | 끔 |
| staleTime | 10초 | 30초 |
| 수집 중 폴링 | 3초 | 3초 |

- **전일 종가 수평선** 표시 (기준선)
- **피봇 레벨** (지지/저항) 표시
- **목표가 수평선** 표시 (알림 규칙 연동)
- 수동 새로고침: `force_refresh=true`로 캐시 무시 + 재수집
- 백그라운드 수집 상태: Spinner + "수집 중" 안내
- 상세 동작은 [INTRADAY.md](./INTRADAY.md) 참조

▶ 상세: [3-7.IntradayChart.md](./3-7.IntradayChart.md)

### 3-8. PriceTargetPanel (알림 설정)

분봉 차트 하단에 위치하는 3탭 알림 설정 패널.

| 탭 | 알림 유형 | 설명 |
|----|----------|------|
| **목표가** | buy / sell | 매수·매도 목표가 도달 알림 |
| **급등/급락** | price_change | 장중 등락률 ±N% 초과 알림 |
| **매매시그널** | trading_signal | 외국인+기관 동시 매수/매도 알림 |

- 규칙 CRUD: 생성, 수정, 삭제, 활성/비활성 토글
- 현재가 기준 괴리율 표시
- Optimistic Update로 즉각 UI 반영

▶ 상세: [3-8.PriceTargetPanel.md](./3-8.PriceTargetPanel.md)

### 3-9. 3종 알림 감지 (`useAlertChecker`)

페이지가 열려 있는 동안 **실시간 알림 감지**를 수행하는 훅.

| 알림 유형 | 감지 로직 |
|----------|----------|
| **목표가 도달** | 분봉 최신 가격이 매수(below)/매도(above) 목표가 돌파 |
| **급등/급락** | 장중 등락률(전일종가 대비)이 설정 임계% 초과 |
| **매매 시그널** | 외국인+기관 동시 순매수 또는 동시 순매도 감지 |

- 세션 내 동일 규칙 **중복 발생 방지** (`firedRef`)
- 토스트 알림(5초) + 전역 알림 저장소(`AlertContext`) 저장 → Header 벨 아이콘 표시
- 백엔드 `POST /api/alerts/trigger` 호출로 이력 기록

▶ 상세: [3-9.useAlertChecker.md](./3-9.useAlertChecker.md)

### 3-10. 최근 뉴스 (NewsTimeline)

- 최근 7일, 최대 10건
- 타임라인 형태 표시
- 분석 옵션 (`analyze: true`)

▶ 상세: [3-10.NewsTimeline.md](./3-10.NewsTimeline.md)

### 3-11. 가격 데이터 테이블 (PriceTable)

- **접기/펼치기** 토글 (기본: 접힘)
- 페이지당 20건
- 날짜, OHLC, 거래량, 등락률 컬럼

▶ 상세: [3-11.PriceTable.md](./3-11.PriceTable.md)

---

## 4. 상태 관리

| 상태 | 저장소 | 용도 |
|------|--------|------|
| `etf` | React Query | 종목 기본 정보 |
| `pricesData` | React Query | 가격 데이터 (날짜 범위별) |
| `tradingFlowData` | React Query | 매매 동향 (날짜 범위별) |
| `insightsData` | React Query | 인사이트·전략 |
| `newsData` | React Query | 뉴스 |
| `intradayData` | React Query | 분봉 데이터 |
| `alertRules` | React Query | 알림 규칙 |
| `extendedPricesData` | React Query | 기술지표용 확장 가격 |
| `dateRange` | useState | 선택된 날짜 범위 |
| `isTableExpanded` | useState | 가격 테이블 접힘 상태 |
| `showRSI` / `showMACD` | useState | 기술지표 토글 (기본 켜짐) |
| `isMarketHours` | useState | 장중 여부 (1분마다 재확인) |
| `settings` | SettingsContext | 기본 날짜 범위, 표시 옵션 |

---

## 5. UI 상태별 처리

| 상태 | 표시 |
|------|------|
| **ETF 로딩** | 중앙 Spinner (전체 페이지 블로킹) |
| **ETF 에러** | ErrorFallback 컴포넌트 |
| **가격/매매동향 로딩** | 각 차트 영역별 개별 LoadingIndicator |
| **가격/매매동향 에러** | 각 차트 영역별 ErrorFallback + 재시도 버튼 |
| **분봉 로딩** | 300px 높이 Spinner |
| **분봉 수집 중** | Spinner + "수집 중" + "잠시 후 자동 갱신" 안내 |
| **분봉 데이터 없음** | "장중이 아니거나 휴장일" 안내 텍스트 |
| **뉴스 로딩/에러** | NewsTimeline 내부 처리 |
| **인사이트 없음** | InsightSummary 자동 숨김 |

---

## 6. 설정 연동

| 설정 항목 | 영향 |
|----------|------|
| `defaultDateRange` (7D/1M/3M) | 초기 날짜 범위 (사용자 미변경 시) |
| `display.showVolume` | 가격 차트 표시 여부 |
| `display.showTradingFlow` | 매매 동향 차트 표시 여부 |

---

## 7. 색상 규칙

한국 금융 관례를 따름:

| 상태 | 색상 |
|------|------|
| 상승 (양수) | 빨간색 (`text-red-600` / `dark:text-red-400`) |
| 하락 (음수) | 파란색 (`text-blue-600` / `dark:text-blue-400`) |
| 보합 (0) | 회색 (`text-gray-600`) |

---

## 8. 관련 파일

### 프론트엔드

| 파일 | 역할 |
|------|------|
| `pages/ETFDetail.jsx` | 페이지 컨테이너. 데이터 조회, 상태 관리, 레이아웃 |
| `components/etf/ETFHeader.jsx` | Sticky 헤더 |
| `components/etf/InsightSummary.jsx` | 인사이트 요약 (핵심 포인트 + 리스크) |
| `components/etf/StrategySummary.jsx` | 투자 전략 (비중확대/보유/관망/비중축소) |
| `components/etf/ETFCharts.jsx` | 차트 4종 통합 컨테이너 |
| `components/charts/PriceChart.jsx` | 캔들스틱 + 거래량 차트 |
| `components/charts/TradingFlowChart.jsx` | 투자자별 매매 동향 차트 |
| `components/charts/RSIChart.jsx` | RSI 기술지표 차트 |
| `components/charts/MACDChart.jsx` | MACD 기술지표 차트 |
| `components/charts/IntradayChart.jsx` | 분봉 차트 |
| `components/charts/DateRangeSelector.jsx` | 날짜 범위 선택기 |
| `components/etf/PriceTargetPanel.jsx` | 알림 설정 패널 (3탭) |
| `components/etf/PriceTable.jsx` | 가격 데이터 테이블 |
| `components/news/NewsTimeline.jsx` | 뉴스 타임라인 |
| `hooks/useAlertChecker.js` | 3종 알림 실시간 감지 훅 |
| `utils/insights.js` | 인사이트 자동 생성 (룰 기반) |
| `utils/technicalIndicators.js` | RSI, MACD, 지지/저항선 계산 |
| `utils/dateRange.js` | 날짜 범위 계산 유틸 |

### 백엔드

| 파일 | API |
|------|-----|
| `routers/etfs.py` | 종목 정보, 가격, 매매동향, 인사이트, 분봉 |
| `routers/news.py` | 뉴스 조회 |
| `routers/alerts.py` | 알림 규칙 CRUD, 트리거 기록 |
| `services/intraday_collector.py` | 분봉 수집 (전체/증분) |
| `services/insights_service.py` | 인사이트·전략 생성 |
