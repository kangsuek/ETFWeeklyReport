# useAlertChecker: 3ì¢… ì•Œë¦¼ ì‹¤ì‹œê°„ ê°ì§€

> ğŸ“„ **ìƒìœ„ ë¬¸ì„œ**: [ETF_DETAIL.md](./ETF_DETAIL.md) Â§ 3-9

ì¢…ëª© ìƒì„¸ í˜ì´ì§€ê°€ ì—´ë ¤ ìˆëŠ” ë™ì•ˆ **ì‹¤ì‹œê°„ìœ¼ë¡œ 3ì¢… ì•Œë¦¼**ì„ ê°ì§€í•˜ëŠ” í›…. ëª©í‘œê°€ ë„ë‹¬Â·ê¸‰ë“±/ê¸‰ë½Â·ë§¤ë§¤ ì‹œê·¸ë„ì„ íŒë³„í•˜ê³ , í† ìŠ¤íŠ¸Â·AlertContextÂ·ë°±ì—”ë“œ íŠ¸ë¦¬ê±° ê¸°ë¡ì„ ìˆ˜í–‰í•œë‹¤.

---

## 1. ë™ì‘ ë°©ì‹ ê°œìš”

- **í˜¸ì¶œ**: ETFDetailì—ì„œ 1íšŒ, tickerÂ·alertRulesÂ·intradayDataÂ·previousCloseÂ·tradingFlowData ì „ë‹¬
- **ë¶€ìˆ˜ íš¨ê³¼**: í† ìŠ¤íŠ¸ í‘œì‹œ, AlertContext.pushAlert, POST /api/alerts/trigger
- **ë°˜í™˜ê°’**: ì—†ìŒ (void í›…)
- **ì¤‘ë³µ ë°©ì§€**: `firedRef`(Set), `lastTradingFlowDateRef`ë¡œ ì„¸ì…˜ ë‚´ ì¬ë°œìƒ ì°¨ë‹¨

---

## 2. ê°ì§€ ëŒ€ìƒ ë° ë¡œì§

### 2-1. ëª©í‘œê°€ ë„ë‹¬ (useEffect: intradayData, alertRules)

| ê·œì¹™ | ì¡°ê±´ | hit |
|------|------|-----|
| buy + below | currentPrice â‰¤ target | ì•Œë¦¼ |
| buy + above | currentPrice â‰¥ target | ì•Œë¦¼ |
| sell + above | currentPrice â‰¥ target | ì•Œë¦¼ |
| sell + below | currentPrice â‰¤ target | ì•Œë¦¼ |

- `currentPrice`: intradayData.data[ë§ˆì§€ë§‰].price
- ëŒ€ìƒ: alert_type âˆˆ { buy, sell }, is_active === true

### 2-2. ê¸‰ë“±/ê¸‰ë½ (useEffect: intradayData, previousClose, alertRules)

| ê·œì¹™ direction | ì¡°ê±´ | hit |
|---------------|------|-----|
| above | changePct â‰¥ threshold | ì•Œë¦¼ |
| below | changePct â‰¤ -threshold | ì•Œë¦¼ |
| both | \|changePct\| â‰¥ threshold | ì•Œë¦¼ |

- `changePct` = (currentPrice - previousClose) / previousClose * 100
- `threshold` = rule.target_price (ì„ê³„ %)
- ëŒ€ìƒ: alert_type === 'price_change', is_active

### 2-3. ë§¤ë§¤ ì‹œê·¸ë„ (useEffect: tradingFlowData, alertRules)

| ì¡°ê±´ | hit |
|------|-----|
| foreign_net > 0 && institutional_net > 0 | "ì™¸êµ­ì¸+ê¸°ê´€ ë™ì‹œ ìˆœë§¤ìˆ˜" |
| foreign_net < 0 && institutional_net < 0 | "ì™¸êµ­ì¸+ê¸°ê´€ ë™ì‹œ ìˆœë§¤ë„" |

- `latest` = tradingFlowData[0] (ìµœì‹  1ì¼)
- **ë‚ ì§œë³„ ì¤‘ë³µ ë°©ì§€**: `lastTradingFlowDateRef`ì— dateKey ì €ì¥, ê°™ìœ¼ë©´ ìŠ¤í‚µ
- ëŒ€ìƒ: alert_type === 'trading_signal', is_active

---

## 3. fireAlert í—¬í¼

```javascript
fireAlert(rule, message, toastType)
```

1. `key = ${rule.id}-${rule.alert_type}` â†’ firedRefì— ìˆìœ¼ë©´ return
2. firedRef.add(key)
3. toast[toastType](message, 5000)
4. alertStore.pushAlert({ ticker, tickerName, alert_type, message })
5. alertApi.recordTrigger({ rule_id, ticker, alert_type, message }).catch(() => {})
```

---

## 4. ì¢…ëª© ë³€ê²½ ì‹œ ì´ˆê¸°í™”

```javascript
useEffect(() => {
  firedRef.current = new Set()
  lastTradingFlowDateRef.current = null
}, [ticker])
```

---

## 5. í† ìŠ¤íŠ¸ íƒ€ì…

| ì•Œë¦¼ | toastType |
|------|-----------|
| buy ëª©í‘œê°€ | info |
| sell ëª©í‘œê°€ | success |
| ê¸‰ë“± | warning |
| ê¸‰ë½ | error |
| ë™ì‹œ ìˆœë§¤ìˆ˜ | success |
| ë™ì‹œ ìˆœë§¤ë„ | error |

---

## 6. ë¬¸ì œ í•´ê²°

| í˜„ìƒ | ì›ì¸ | ì¡°ì¹˜ |
|------|------|------|
| ëª©í‘œê°€ ì•Œë¦¼ ì•ˆ ì˜´ | intradayData ì—†ìŒ ë˜ëŠ” alertRules ë¹„í™œì„± | ë¶„ë´‰ ë¡œë“œ, is_active í™•ì¸ |
| ê¸‰ë“±/ê¸‰ë½ ì•ˆ ì˜´ | previousClose null | pricesData 2ê±´ ì´ìƒ í™•ì¸ |
| ë§¤ë§¤ ì‹œê·¸ë„ ì¤‘ë³µ | lastTradingFlowDateRef ë¯¸ì‘ë™ | ê°™ì€ dateKey ìŠ¤í‚µ ë¡œì§ í™•ì¸ |
| í† ìŠ¤íŠ¸ë§Œ ë˜ê³  ë²¨ì— ì•ˆ ëœ¸ | alertStore.pushAlert ì‹¤íŒ¨ | AlertContext ì—°ê²° í™•ì¸ |
| íŠ¸ë¦¬ê±° ê¸°ë¡ ì‹¤íŒ¨ | API ì—ëŸ¬ | recordTrigger catch ë¡œê·¸, ë°±ì—”ë“œ í™•ì¸ |

---

## 7. ìš”ì•½

| í•­ëª© | ë‚´ìš© |
|------|------|
| í›… | `hooks/useAlertChecker.js` |
| ì…ë ¥ | ticker, tickerName, alertRules, intradayData, previousClose, tradingFlowData |
| ì¶œë ¥ | ì—†ìŒ (ë¶€ìˆ˜ íš¨ê³¼ë§Œ) |
| API | POST /api/alerts/trigger |
| ì¤‘ë³µ ë°©ì§€ | firedRef, lastTradingFlowDateRef |

---

## 8. ê´€ë ¨ íŒŒì¼

| íŒŒì¼ | ì—­í•  |
|------|------|
| `frontend/src/hooks/useAlertChecker.js` | 3ì¢… ì•Œë¦¼ ê°ì§€ ë¡œì§ |
| `frontend/src/pages/ETFDetail.jsx` | í›… í˜¸ì¶œ, ë°ì´í„° ì „ë‹¬ |
| `frontend/src/contexts/AlertContext.jsx` | pushAlert |
| `frontend/src/contexts/ToastContext.jsx` | toast |
| `frontend/src/services/api.js` | alertApi.recordTrigger |
| `backend` | alerts trigger API |
