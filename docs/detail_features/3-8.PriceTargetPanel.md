# PriceTargetPanel: ì•Œë¦¼ ì„¤ì • íŒ¨ë„

> ğŸ“„ **ìƒìœ„ ë¬¸ì„œ**: [ETF_DETAIL.md](./ETF_DETAIL.md) Â§ 3-8

ë¶„ë´‰ ì°¨íŠ¸ í•˜ë‹¨ì— ìœ„ì¹˜í•˜ëŠ” **3íƒ­ ì•Œë¦¼ ì„¤ì • íŒ¨ë„**. ëª©í‘œê°€Â·ê¸‰ë“±/ê¸‰ë½Â·ë§¤ë§¤ì‹œê·¸ë„ ê·œì¹™ì˜ CRUD, í™œì„±/ë¹„í™œì„± í† ê¸€, í˜„ì¬ê°€ ê¸°ì¤€ ê´´ë¦¬ìœ¨ í‘œì‹œ. Optimistic Updateë¡œ ì¦‰ì‹œ UI ë°˜ì˜.

---

## 1. ë™ì‘ ë°©ì‹ ê°œìš”

- **ìœ„ì¹˜**: ë¶„ë´‰ ì°¨íŠ¸ ì¹´ë“œ ë‚´ë¶€, IntradayChartÂ·ëª©í‘œê°€ ì„¤ëª… í•˜ë‹¨
- **API**: `GET /api/alerts/{ticker}` (ê·œì¹™ ì¡°íšŒ), create/update/delete ì—”ë“œí¬ì¸íŠ¸
- **ìºì‹œ**: queryKey `['alertRules', ticker]`, staleTime 30ì´ˆ
- **currentPrice**: ë¶„ë´‰ ìµœì‹ ê°€ ë˜ëŠ” pricesData[0].close_price (ë¶„ë´‰ ì—†ì„ ë•Œ)

---

## 2. íƒ­ë³„ ì•Œë¦¼ ìœ í˜•

| íƒ­ key | label | alert_type | direction | target_price |
|--------|-------|------------|-----------|--------------|
| target | ëª©í‘œê°€ | buy / sell | below / above | ê¸ˆì•¡ |
| change | ê¸‰ë“±/ê¸‰ë½ | price_change | above / below / both | ì„ê³„ % |
| signal | ë§¤ë§¤ì‹œê·¸ë„ | trading_signal | above / below / both | 0 (ë¯¸ì‚¬ìš©) |

---

## 3. CRUD ë° ë®¤í…Œì´ì…˜

| ë™ì‘ | API | onSuccess |
|------|-----|-----------|
| ìƒì„± | alertApi.createRule(payload) | invalidate, resetForm |
| ìˆ˜ì • | alertApi.updateRule(id, data) | invalidate, setEditingId(null), resetForm |
| ì‚­ì œ | alertApi.deleteRule(id) | invalidate |
| í† ê¸€ | alertApi.updateRule(id, { is_active }) | invalidate |

---

## 4. í¼ ê¸°ë³¸ê°’ (FORM_DEFAULTS)

```javascript
buy:             { alert_type: 'buy',             direction: 'below', target_price: '', memo: '' }
sell:            { alert_type: 'sell',            direction: 'above', target_price: '', memo: '' }
price_change:    { alert_type: 'price_change',    direction: 'both',  target_price: '', memo: '' }
trading_signal:  { alert_type: 'trading_signal',  direction: 'both',  target_price: '0', memo: '' }
```

---

## 5. ê´´ë¦¬ìœ¨ ê³„ì‚°

```javascript
calcDiffPct(targetPrice) = ((targetPrice - currentPrice) / currentPrice * 100).toFixed(1)
```

- ëª©í‘œê°€ íƒ­: ê° ê·œì¹™ë³„ í˜„ì¬ê°€ ëŒ€ë¹„ ê´´ë¦¬ìœ¨ % í‘œì‹œ
- ê¸‰ë“±/ê¸‰ë½: target_priceê°€ ì„ê³„ %ì´ë¯€ë¡œ ê´´ë¦¬ìœ¨ ëŒ€ì‹  ì„ê³„ê°’ í‘œì‹œ

---

## 6. Submit ê²€ì¦

- trading_signal: target_price 0 ê³ ì •, ë³„ë„ ê²€ì¦ ì—†ìŒ
- price_change: target_priceëŠ” parseFloat (ì„ê³„ %)
- buy/sell: target_priceëŠ” fromCommaString (ê¸ˆì•¡), NaN ë˜ëŠ” â‰¤0ì´ë©´ ì œì¶œ ë¬´ì‹œ

---

## 7. Optimistic Update

- ë®¤í…Œì´ì…˜ í˜¸ì¶œ í›„ ì„œë²„ ì‘ë‹µ ì „ì— `invalidateQueries`ë¡œ ì¿¼ë¦¬ ë¬´íš¨í™” â†’ refetch
- UIëŠ” refetch ì™„ë£Œ ì‹œ ê°±ì‹  (ì‹¤ì œ Optimistic UpdateëŠ” ë³„ë„ êµ¬í˜„ ì—†ì´ invalidateë¡œ ì²˜ë¦¬)

---

## 8. ë¬¸ì œ í•´ê²°

| í˜„ìƒ | ì›ì¸ | ì¡°ì¹˜ |
|------|------|------|
| ê·œì¹™ ëª©ë¡ ì•ˆ ë‚˜ì˜´ | alertRules ì¿¼ë¦¬ ì—ëŸ¬ | Network íƒ­, ë°±ì—”ë“œ ë¡œê·¸ í™•ì¸ |
| ê´´ë¦¬ìœ¨ NaN | currentPrice null | ë¶„ë´‰ ë˜ëŠ” ì¼ë´‰ ì¢…ê°€ ì „ë‹¬ í™•ì¸ |
| ìˆ˜ì • ì‹œ í¼ ì´ˆê¸°í™” ì•ˆ ë¨ | resetForm/ setEditingId ë¯¸í˜¸ì¶œ | onSuccess í•¸ë“¤ëŸ¬ í™•ì¸ |
| í† ê¸€ ë°˜ì˜ ì•ˆ ë¨ | invalidate ëˆ„ë½ | toggleMutation onSuccessì— invalidate |

---

## 9. ìš”ì•½

| í•­ëª© | ë‚´ìš© |
|------|------|
| ì»´í¬ë„ŒíŠ¸ | `components/etf/PriceTargetPanel.jsx` |
| API | GET/POST/PUT/DELETE alerts |
| íƒ­ | ëª©í‘œê°€, ê¸‰ë“±/ê¸‰ë½, ë§¤ë§¤ì‹œê·¸ë„ |
| ì…ë ¥ | ticker, currentPrice |
| ìºì‹œ | queryKey ['alertRules', ticker], 30ì´ˆ |

---

## 10. ê´€ë ¨ íŒŒì¼

| íŒŒì¼ | ì—­í•  |
|------|------|
| `frontend/src/components/etf/PriceTargetPanel.jsx` | 3íƒ­ ì•Œë¦¼ íŒ¨ë„ UI ë° ë¡œì§ |
| `frontend/src/services/api.js` | alertApi |
| `frontend/src/pages/ETFDetail.jsx` | currentPrice ê³„ì‚° í›„ ì „ë‹¬ |
| `backend/app/routers/alerts.py` | ì•Œë¦¼ ê·œì¹™ CRUD |
