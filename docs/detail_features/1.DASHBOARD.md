# 대시보드 기능 명세서

대시보드는 애플리케이션의 **메인 화면**(`/`)으로, 등록된 전체 종목의 현황을 한눈에 파악할 수 있는 페이지이다.

---

## 1. 화면 구성

```
┌──────────────────────────────────────────────┐
│  PageHeader ("Insights Dashboard")           │
├──────────────────────────────────────────────┤
│  DashboardFilters (정렬 버튼: 설정순/타입/이름/테마/사용자지정) │
├──────────────────────────────────────────────┤
│  날짜·업데이트 정보 바                         │
│  [오늘 날짜] [마지막 수집일시] [마지막 업데이트]  │
│                    [자동 갱신 토글] [새로고침]   │
├──────────────────────────────────────────────┤
│  PortfolioHeatmap (Treemap — 전체 현황)       │
├──────────────────────────────────────────────┤
│  RecommendationCards (ETF 추천 — 3개 프리셋)   │
├──────────────────────────────────────────────┤
│  ETFCardGrid (종목 카드 그리드, 드래그 앤 드롭)  │
│  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐        │
│  │ Card │ │ Card │ │ Card │ │ Card │        │
│  └──────┘ └──────┘ └──────┘ └──────┘        │
│  ┌──────┐ ┌──────┐ ...                       │
│  │ Card │ │ Card │                           │
│  └──────┘ └──────┘                           │
└──────────────────────────────────────────────┘
```

---

## 2. 데이터 흐름

### 사용하는 API

| 순서 | API | 용도 | 캐시 정책 |
|------|-----|------|----------|
| 1 | `GET /api/etfs` | 전체 종목 목록 조회 | staleTime 5분, 윈도우 포커스 시 재조회 |
| 2 | `POST /api/etfs/batch-summary` | N개 종목의 최근 가격·매매동향·뉴스 일괄 조회 | staleTime 30초 |
| 3 | `GET /api/data/scheduler-status` | 스케줄러 상태 (마지막 수집 시각) | staleTime 10초, 30초 간격 자동 갱신 |
| 4 | `GET /api/scanner/recommendations` | ETF 추천 프리셋 (주간 상위, 외국인/기관 매수 등) | staleTime 5분 |

### 요청 순서

1. `GET /api/etfs` → 종목 목록 취득
2. 종목 목록 로드 완료 후 (`enabled: !!etfs`) → `POST /api/etfs/batch-summary` 호출 (N+1 쿼리 방지)
3. 병렬로 스케줄러 상태, 추천 프리셋 조회

### 새로고침 동작

```
[새로고침 클릭]
  → POST /api/data/collect-all?days=1 (네이버에서 최신 데이터 수집)
  → React Query 캐시 무효화 (etfs, batch-summary, scheduler-status)
  → UI 갱신
  → 실패 시: 캐시만 무효화하여 DB 최신 데이터 재조회
```

---

## 3. 컴포넌트 상세

### 3-1. DashboardFilters (정렬 필터)

종목 카드의 정렬 순서를 제어한다.

| 정렬 기준 | 동작 |
|----------|------|
| **설정 순서** (기본) | `stocks.json` / 설정 페이지에서 지정한 순서 |
| **타입** | STOCK → ETF 순. 같은 타입 내에서는 이름순 |
| **이름** | 한글 가나다순 (`localeCompare('ko-KR')`) |
| **테마** | 테마명 가나다순. 같은 테마 내에서는 이름순 |
| **사용자 지정** | LocalStorage에 저장된 커스텀 순서. 드래그 앤 드롭으로 변경 가능 |

- 같은 버튼을 다시 클릭하면 **정렬 방향 전환** (오름차순 ↔ 내림차순)
- 활성 정렬 버튼에 ▲/▼ 화살표 표시
- "설정 순서" / "사용자 지정" 선택 시 안내 메시지 표시

### 3-2. PortfolioHeatmap (포트폴리오 히트맵)

등록된 전체 종목을 Treemap으로 시각화한다.

| 속성 | 설명 |
|------|------|
| **셀 크기** | 투자 종목(매입가+수량 있음) = 3 : 관심 종목 = 1 |
| **셀 색상** | 일간 변동률 기반 그라데이션 (녹색=상승, 적색=하락) |
| **셀 내용** | 종목명, 종가, 일간 변동률 (셀 크기에 따라 주간 수익률 추가 표시) |
| **테두리** | 투자 종목은 시안(#00e5ff) 테두리로 강조 |
| **인터랙션** | 셀 클릭 → ETF 상세 페이지 이동. 네이티브 툴팁(hover) 제공 |

**색상 매핑 (일간 변동률)**:

| 범위 | 색상 |
|------|------|
| +3% 이상 | 진한 녹색 (#15803d) |
| +1.5% ~ +3% | 녹색 (#16a34a) |
| +0.5% ~ +1.5% | 연한 녹색 (#22c55e) |
| 0% ~ +0.5% | 옅은 녹색 (#86efac) |
| -0.5% ~ 0% | 옅은 적색 (#fca5a5) |
| -1.5% ~ -0.5% | 적색 (#ef4444) |
| -3% ~ -1.5% | 진한 적색 (#dc2626) |
| -3% 이하 | 매우 진한 적색 (#991b1b) |

**반응형**: 셀 크기에 따라 표시 정보 자동 조절 (너비/높이 부족 시 항목 생략)

### 3-3. RecommendationCards (ETF 추천)

스크리닝 API의 추천 프리셋을 3개 카드로 표시한다.

| 프리셋 | 내용 |
|--------|------|
| **주간 수익률 상위** | weekly_return 기준 Top 3 |
| **외국인 매수** | foreign_net 기준 Top 3 |
| **기관 매수** | institutional_net 기준 Top 3 |

- 각 카드에 종목명, 종가, 주간 수익률 표시
- 종목 클릭: 등록된 종목이면 ETF 상세로, 미등록이면 설정 페이지(종목 추가)로 이동
- "더보기" 링크 → 스크리닝 페이지로 이동
- 데이터 없으면 섹션 자체 미표시

### 3-4. ETFCardGrid (종목 카드 그리드)

종목별 카드를 반응형 그리드로 배치한다.

**그리드 레이아웃**: `1열(모바일) → 2열(sm) → 3열(lg) → 4열(xl)`

**드래그 앤 드롭** (@dnd-kit):
- "사용자 지정" 정렬 모드에서 카드 드래그로 순서 변경
- 8px 이동 후 드래그 시작 (클릭과 구분)
- 키보드 접근성 지원 (KeyboardSensor)
- 드래그 중 원본 카드 50% 투명, DragOverlay에 복제본 표시
- 순서 변경 시 Optimistic Update → 백엔드 `POST /api/settings/stocks/reorder` 동기화
- 실패 시 자동 롤백

### 3-5. ETFCard (종목 카드)

개별 종목의 요약 정보를 표시하는 카드 컴포넌트.

**표시 정보**:

| 영역 | 내용 |
|------|------|
| **헤더** | 종목명, 타입 뱃지 (ETF/STOCK), 테마 |
| **가격** | 종가 (bold, 큰 폰트), 일간 등락률 |
| **OHLC** | 시가·고가·저가 (3열 그리드) |
| **부가 지표** | 거래량, 주간 수익률, 매입가 대비 수익률 (투자 종목만) |
| **미니 차트** | 최근 5일 캔들스틱 차트 (SVG, 호버 시 OHLC 툴팁) |
| **매매 동향** | 개인/기관/외국인 순매수 (최근 1일) |
| **뉴스** | 최근 뉴스 제목 1건 + 건수 뱃지 |
| **하단** | 종목 코드 (ticker) |

**데이터 전략**:
- `batchSummary` 데이터가 있으면 사용 (N+1 방지)
- 없으면 개별 API 호출로 폴백 (`etfApi.getPrices`, `newsApi.getByTicker` 등)

**색상 규칙** (한국 금융 관례):
- 상승 (양수): 빨간색 (`text-red-600`)
- 하락 (음수): 파란색 (`text-blue-600`)
- 보합 (0): 회색 (`text-gray-600`)

**인터랙션**: 카드 전체가 `<Link>`로 감싸져 있어 클릭 시 ETF 상세 페이지(`/etf/:ticker`)로 이동

---

## 4. 자동 갱신

| 설정 | 기본값 | 설명 |
|------|--------|------|
| `autoRefresh.enabled` | false | 자동 갱신 활성화 여부 (체크박스) |
| `autoRefresh.interval` | 설정에 따름 | 갱신 주기 (밀리초) |

- 활성화 시 `setInterval`로 `handleRefreshAll()` 반복 실행
- 갱신 동작: 데이터 수집(`collectAll`) → 캐시 무효화 → UI 갱신
- 토스트 알림: 수집 시작, 성공, 실패 시 각각 표시

---

## 5. 상태 관리

| 상태 | 저장소 | 용도 |
|------|--------|------|
| `etfs` | React Query | 종목 목록 (서버 상태) |
| `batchSummary` | React Query | 배치 요약 데이터 (서버 상태) |
| `schedulerStatus` | React Query | 스케줄러 상태 (서버 상태) |
| `sortBy` / `sortDirection` | useState | 현재 정렬 기준·방향 (페이지 로컬) |
| `cardOrder` | SettingsContext → LocalStorage | 사용자 지정 카드 순서 (영구 보존) |
| `autoRefresh` | SettingsContext → LocalStorage | 자동 갱신 설정 (영구 보존) |
| `lastUpdate` | useState | 마지막 업데이트 시각 (표시용) |

---

## 6. UI 상태별 처리

| 상태 | 표시 |
|------|------|
| **로딩** | 스켈레톤 카드 6개 표시 (`ETFCardSkeleton`) |
| **에러** | 에러 메시지 + "다시 시도" 버튼 |
| **빈 데이터** | "등록된 종목이 없습니다" 안내 |
| **정상** | 히트맵 + 추천 + 카드 그리드 표시 |

---

## 7. 관련 파일

### 프론트엔드

| 파일 | 역할 |
|------|------|
| `pages/Dashboard.jsx` | 페이지 컨테이너. 데이터 조회, 정렬, 갱신 로직 |
| `components/dashboard/DashboardFilters.jsx` | 정렬 필터 UI |
| `components/dashboard/PortfolioHeatmap.jsx` | Treemap 히트맵 |
| `components/dashboard/RecommendationCards.jsx` | ETF 추천 카드 |
| `components/dashboard/ETFCardGrid.jsx` | 드래그 앤 드롭 카드 그리드 |
| `components/etf/ETFCard.jsx` | 개별 종목 카드 |
| `components/common/ETFCardSkeleton.jsx` | 로딩 스켈레톤 |

### 백엔드

| 파일 | API |
|------|-----|
| `routers/etfs.py` | `GET /api/etfs`, `POST /api/etfs/batch-summary` |
| `routers/data.py` | `GET /api/data/scheduler-status`, `POST /api/data/collect-all` |
| `routers/scanner.py` | `GET /api/scanner/recommendations` |
| `routers/settings.py` | `POST /api/settings/stocks/reorder` |
