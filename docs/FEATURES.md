# 제공 기능

ETF Weekly Report의 백엔드 API와 프론트엔드 기능을 정리한 문서입니다.

## 목차
- [백엔드 API](#백엔드-api)
- [프론트엔드 기능](#프론트엔드-기능)
- [데이터 수집](#데이터-수집)
- [캐시 및 성능 최적화](#캐시-및-성능-최적화)

---

## 백엔드 API

### 1. ETF/주식 종목 관리 (`/api/etfs`)

#### 1.1 종목 조회
- **GET `/api/etfs`** - 전체 종목 목록 조회
  - 등록된 모든 ETF 및 주식 종목 (6개) 반환
  - 캐시: 5분 (정적 데이터)

- **GET `/api/etfs/{ticker}`** - 특정 종목 상세 정보
  - 종목 코드, 이름, 타입(ETF/STOCK), 테마, 상장일, 운용보수
  - 캐시: 5분 (정적 데이터)

#### 1.2 가격 데이터
- **GET `/api/etfs/{ticker}/prices`** - 가격 데이터 조회
  - 시가, 고가, 저가, 종가, 거래량, 등락률
  - 쿼리: `start_date`, `end_date`, `days`
  - 자동 수집 지원: 데이터 부족 시 자동으로 네이버 금융에서 수집
  - 캐시: 30초 (빠르게 변하는 데이터)

- **POST `/api/etfs/{ticker}/collect`** - 가격 데이터 수집 트리거
  - 네이버 금융에서 수동으로 데이터 수집
  - 쿼리: `days` (기본값: 10일)
  - API Key 필요

#### 1.3 투자자별 매매동향
- **GET `/api/etfs/{ticker}/trading-flow`** - 매매동향 조회
  - 개인, 기관, 외국인 순매수 데이터
  - 쿼리: `start_date`, `end_date`
  - 자동 수집 지원
  - 캐시: 30초

- **POST `/api/etfs/{ticker}/collect-trading-flow`** - 매매동향 수집
  - 쿼리: `days` (1-90일, 기본값: 10일)
  - API Key 필요

#### 1.4 종목 지표
- **GET `/api/etfs/{ticker}/metrics`** - 주요 지표 조회
  - 수익률 (1주, 1개월, YTD)
  - 연환산 변동성
  - 캐시: 1분

#### 1.5 종목 비교
- **GET `/api/etfs/compare`** - 여러 종목 비교
  - 쿼리: `tickers` (2-6개, 쉼표로 구분), `start_date`, `end_date`
  - 정규화 가격 (시작일 = 100)
  - 종목별 통계 (수익률, 변동성, 최대낙폭, 샤프비율)
  - 상관관계 행렬
  - 캐시: 1분

#### 1.6 배치 요약 데이터
- **POST `/api/etfs/batch-summary`** - 여러 종목 요약 일괄 조회
  - N+1 쿼리 최적화 (대시보드용)
  - Body: `tickers`, `price_days`, `news_limit`
  - 종목별 최신 가격, 차트 데이터, 매매동향, 뉴스 반환
  - 캐시: 30초

### 2. 뉴스 (`/api/news`)

- **GET `/api/news/{ticker}`** - 종목별 뉴스 조회
  - 쿼리: `start_date`, `end_date`
  - 뉴스 제목, URL, 출처, 날짜, 관련도 점수
  - 캐시: 1분

- **POST `/api/news/{ticker}/collect`** - 뉴스 수집
  - 네이버 검색 API 활용
  - 쿼리: `days` (1-30일, 기본값: 7일)
  - API Key 필요

### 3. 데이터 수집 관리 (`/api/data`)

#### 3.1 일괄 수집
- **POST `/api/data/collect-all`** - 전체 종목 일괄 수집
  - 쿼리: `days` (기본값: 1일, 최대: 365일)
  - 가격, 매매동향, 뉴스 수집
  - 종목별 수집 결과 상세 정보 반환
  - Rate Limit: 데이터 수집용 제한
  - API Key 필요

- **POST `/api/data/backfill`** - 히스토리 데이터 백필
  - 쿼리: `days` (기본값: 90일, 최대: 365일)
  - 과거 데이터 대량 수집
  - API Key 필요

#### 3.2 상태 조회
- **GET `/api/data/status`** - 데이터 수집 상태
  - 종목별 최근 데이터 개수, 최신 날짜
  - 캐시: 10초

- **GET `/api/data/scheduler-status`** - 스케줄러 상태
  - 스케줄러 실행 상태, 마지막 수집 시간
  - 캐시: 10초

- **GET `/api/data/stats`** - 데이터베이스 통계
  - 테이블별 레코드 수
  - DB 파일 크기
  - 마지막 수집 시간
  - 캐시: 1분

#### 3.3 캐시 관리
- **GET `/api/data/cache/stats`** - 캐시 통계 조회
  - 히트율, 미스율, 캐시 크기
  - Rate Limit: 읽기 전용 제한

- **DELETE `/api/data/cache/clear`** - 캐시 전체 삭제
  - API Key 필요
  - Rate Limit: 위험한 작업 제한

#### 3.4 데이터베이스 관리
- **DELETE `/api/data/reset`** - 데이터베이스 초기화 (위험)
  - prices, news, trading_flow 테이블 삭제
  - etfs 테이블은 유지
  - API Key 필요
  - Rate Limit: 위험한 작업 제한

### 4. 설정 및 종목 관리 (`/api/settings`)

#### 4.1 종목 CRUD
- **POST `/api/settings/stocks`** - 종목 추가
  - Body: `ticker`, `name`, `type`, `theme`, `launch_date`, `expense_ratio`, `search_keyword`, `relevance_keywords`
  - stocks.json 및 DB 자동 동기화
  - API Key 필요

- **PUT `/api/settings/stocks/{ticker}`** - 종목 수정
  - 부분 업데이트 지원
  - API Key 필요

- **DELETE `/api/settings/stocks/{ticker}`** - 종목 삭제
  - Cascade 삭제: 가격, 뉴스, 매매동향 데이터 모두 삭제
  - 삭제된 레코드 수 반환
  - API Key 필요

#### 4.2 종목 검증 및 검색
- **GET `/api/settings/stocks/{ticker}/validate`** - 티커 검증
  - 네이버 금융에서 종목 정보 스크래핑
  - stocks.json 형식으로 반환 (바로 사용 가능)

- **GET `/api/settings/stocks/search`** - 종목 검색 (자동완성용)
  - 쿼리: `q` (검색어, 최소 2자), `type` (STOCK/ETF/ALL)
  - stock_catalog 테이블에서 검색
  - 최대 20개 결과 반환
  - Rate Limit: 검색용 제한

#### 4.3 종목 목록 수집
- **POST `/api/settings/ticker-catalog/collect`** - 전체 종목 목록 수집
  - 코스피, 코스닥, ETF 전체 목록
  - stock_catalog 테이블에 저장
  - 수집 통계 반환 (약 2,500개)
  - API Key 필요
  - Rate Limit: 위험한 작업 제한

### 5. 시스템

- **GET `/api/health`** - 헬스 체크
  - 서버 상태 확인

---

## 프론트엔드 기능

### 1. 대시보드 (`/`)

#### 기본 기능
- 전체 종목 카드 그리드 뷰
- 종목별 최신 가격, 등락률, 거래량 표시
- 주간 수익률 미니 차트
- 최근 뉴스 미리보기 (5개)
- 최근 매매동향 (개인/기관/외국인)

#### 정렬 및 필터
- 정렬 옵션: 타입, 이름, 테마
- 정렬 방향: 오름차순/내림차순
- 컴팩트 모드 지원 (설정)

#### 자동 갱신
- 자동 갱신 토글 (설정 가능)
- 갱신 간격: 30초 (기본값, 설정 변경 가능)
- 수동 새로고침 버튼

#### 데이터 최적화
- 배치 API 호출 (N+1 쿼리 최적화)
- 스켈레톤 로딩 UI
- 에러 바운더리

#### 상태 표시
- 오늘 날짜
- 마지막 데이터 수집 시간 (스케줄러)
- 화면 업데이트 시간

### 2. 종목 상세 (`/etf/:ticker`)

#### 기본 정보
- 종목명, 티커, 타입, 테마
- 운용보수, 상장일 (ETF)
- 최근 가격 정보 (종가, 등락률, 거래량, 일자)

#### 날짜 범위 선택
- 프리셋: 7일, 1개월, 3개월
- 커스텀 날짜 범위 (시작일, 종료일)
- 설정에서 기본값 변경 가능

#### 통계 요약
- 기간 수익률
- 최대/최소 가격
- 평균 거래량
- 변동성

#### 가격 차트
- 캔들스틱 차트 (시가, 고가, 저가, 종가)
- 거래량 차트 (토글 가능)
- 반응형 차트 (모바일 최적화)
- 스크롤 동기화 (매매동향 차트와)

#### 투자자별 매매동향 차트
- 개인, 기관, 외국인 순매수 추이
- 막대 차트 (양수/음수 색상 구분)
- 가격 차트와 스크롤 동기화

#### 가격 데이터 테이블
- 페이지네이션 (20개/페이지)
- 일자, 시가, 고가, 저가, 종가, 거래량, 등락률
- 정렬 가능

#### 뉴스 타임라인
- 최근 뉴스 목록
- 날짜, 제목, 출처, URL
- 외부 링크 (새 탭)

#### 로딩 및 에러 처리
- 스켈레톤 로딩
- 에러 폴백 UI
- 재시도 버튼
- 데이터 부족 시 자동 수집 안내

### 3. 종목 비교 (`/compare`)

#### 종목 선택
- 드롭다운 멀티 셀렉트
- 최소 2개, 최대 6개 종목
- 선택된 종목 배지 표시
- 종목별 색상 구분

#### 날짜 범위 선택
- 프리셋: 7일, 1개월, 3개월
- 커스텀 날짜 범위

#### 정규화 가격 차트
- 시작일 = 100 기준
- 종목별 색상 구분
- 라인 차트
- 툴팁 (날짜, 가격, 종목)

#### 비교 통계 테이블
- 종목별 수익률 (기간, 연환산)
- 변동성 (연환산)
- 최대 낙폭 (MDD)
- 샤프 비율
- 데이터 개수
- 색상 코딩 (성과 기준)

#### 상관관계 행렬
- 종목 간 상관계수 매트릭스
- 히트맵 색상 코딩
- 대각선 = 1.0

### 4. 설정 (`/settings`)

#### 일반 설정
- **다크 모드**: 자동/라이트/다크
- **언어**: 한국어/영어 (준비 중)
- **기본 날짜 범위**: 7일/1개월/3개월
- **자동 갱신**: 활성화/비활성화, 간격 설정

#### 표시 설정
- **거래량 차트 표시**: 종목 상세 페이지
- **매매동향 차트 표시**: 종목 상세 페이지
- **컴팩트 모드**: 대시보드 카드 크기 축소

#### 종목 관리
- 종목 목록 테이블 (티커, 이름, 타입, 테마)
- 종목 추가 폼
  - 티커 검증 (네이버 금융)
  - 자동완성 검색 (stock_catalog)
  - 필수 필드: 티커, 이름, 타입, 테마
  - 선택 필드: 상장일, 운용보수, 검색 키워드
- 종목 수정 (인라인 편집)
- 종목 삭제 (확인 모달)
- 종목 카탈로그 수집 버튼

#### 데이터 관리
- 전체 데이터 수집 버튼
- 백필 (히스토리 데이터) 버튼
- 데이터베이스 통계 표시
- 캐시 통계 표시
- 캐시 클리어 버튼
- 데이터베이스 초기화 버튼 (위험)

#### 설정 저장
- LocalStorage 저장
- 실시간 반영
- 초기화 버튼

### 5. 공통 기능

#### 레이아웃
- 반응형 디자인 (모바일, 태블릿, 데스크탑)
- 네비게이션 헤더
- 푸터 (저작권 정보)
- 다크 모드 지원

#### 상태 관리
- TanStack Query (서버 상태)
- React Context (설정, 토스트)
- LocalStorage (사용자 설정)

#### UI/UX
- 로딩 인디케이터 (스피너, 스켈레톤)
- 에러 바운더리
- 토스트 알림 (성공, 에러, 정보, 경고)
- 모달 (확인, 경고)
- 툴팁

#### 성능 최적화
- Lazy Loading (페이지 컴포넌트)
- Code Splitting (Vite)
- 이미지 최적화
- 메모이제이션 (useMemo, useCallback)
- 가상화 (긴 리스트)

---

## 데이터 수집

### 자동 수집 (스케줄러)
- **실행 시간**: 평일 15:50 (KST) - 장 마감 후
- **수집 데이터**: 당일 가격, 매매동향
- **수집 종목**: 등록된 모든 종목 (6개)
- **재시도**: 실패 시 5분 후 재시도 (최대 3회)
- **로깅**: 수집 결과 로그 기록

### 수동 수집
- **API 엔드포인트**: `/api/data/collect-all`
- **권한**: API Key 필요
- **수집 범위**: 1-365일 (기본값: 1일)
- **백필**: `/api/data/backfill` (기본값: 90일)

### 자동 수집 지원
- **가격 데이터**: 요청 기간에 데이터가 없으면 자동 수집
- **매매동향**: 요청 기간에 데이터가 없으면 자동 수집
- **최대 소요 시간**: 약 30초
- **투명성**: 자동 수집 여부 로그 기록

### 데이터 소스
- **네이버 금융**: 가격, 매매동향
- **네이버 검색 API**: 뉴스

---

## 캐시 및 성능 최적화

### 백엔드 캐시
- **캐시 시스템**: 메모리 기반 LRU 캐시
- **TTL 설정**:
  - 정적 데이터 (종목 정보): 5분
  - 빠르게 변하는 데이터 (가격, 매매동향): 30초
  - 느리게 변하는 데이터 (뉴스, 지표): 1분
  - 상태 정보: 10초
- **캐시 무효화**: 데이터 수집 후 자동 무효화
- **캐시 통계**: 히트율, 미스율, 크기 모니터링

### 프론트엔드 캐시
- **TanStack Query**: 자동 캐싱 및 동기화
- **staleTime**: 백엔드 TTL과 일치
- **gcTime**: 10분 (메모리 유지 시간)
- **리페치 전략**: 윈도우 포커스, 네트워크 재연결

### N+1 쿼리 최적화
- **배치 API**: 여러 종목 데이터 한 번에 조회
- **IN 절 활용**: SQL 쿼리 최적화
- **대시보드**: 6개 API 호출 → 1개 API 호출

### 데이터베이스 최적화
- **인덱스**: ticker, date, type 컬럼
- **Foreign Key**: ON DELETE CASCADE
- **트랜잭션**: 일괄 삽입 시 트랜잭션 사용

### Rate Limiting
- **읽기 전용**: 100회/분
- **기본**: 30회/분
- **데이터 수집**: 10회/분
- **검색**: 60회/분
- **위험한 작업**: 5회/분

---

## 보안

### API Key 인증
- 데이터 수집, 종목 관리, 위험한 작업 시 필요
- 환경 변수로 설정 (`API_KEY`)
- Header: `X-API-Key`

### CORS
- 허용 Origin 설정 (환경 변수)
- Credentials 지원
- 모든 HTTP 메서드 허용

### Rate Limiting
- IP 기반 제한
- 엔드포인트별 다른 제한
- 429 Too Many Requests 반환

---

## 테스트

### 백엔드
- **단위 테스트**: pytest (89% 커버리지)
- **테스트 수**: 196개
- **테스트 대상**: 모델, 서비스, 라우터, 유틸리티

### 프론트엔드
- **단위 테스트**: Vitest + React Testing Library
- **테스트 대상**: 컴포넌트, 유틸리티, 컨텍스트
- **E2E**: 준비 중

---

## 배포

### 백엔드
- **프레임워크**: FastAPI
- **서버**: Uvicorn
- **데이터베이스**: SQLite (개발) / PostgreSQL (프로덕션)
- **스케줄러**: APScheduler

### 프론트엔드
- **빌드**: Vite
- **배포**: 정적 파일 서빙
- **환경 변수**: `.env` 파일

---

## 향후 계획

### Phase 4-6 (진행 중)
- [ ] 리포트 생성 (PDF, Markdown)
- [ ] 백테스팅 기능
- [ ] 포트폴리오 관리
- [ ] 알림 기능 (가격 알림, 뉴스 알림)
- [ ] 사용자 인증 및 권한 관리
- [ ] 다국어 지원 (i18n)

### 성능 개선
- [ ] Redis 캐시 (프로덕션)
- [ ] WebSocket (실시간 데이터)
- [ ] CDN (정적 파일)
- [ ] 서버리스 함수 (데이터 수집)

### 기능 추가
- [ ] 커스텀 지표 추가
- [ ] 차트 템플릿 저장
- [ ] 데이터 내보내기 (CSV, Excel)
- [ ] 공유 기능 (스냅샷 링크)

---

## 문서
- [README.md](../README.md) - 프로젝트 개요
- [ARCHITECTURE.md](./ARCHITECTURE.md) - 시스템 아키텍처
- [API_SPECIFICATION.md](./API_SPECIFICATION.md) - API 명세서
- [DATABASE_SCHEMA.md](./DATABASE_SCHEMA.md) - DB 스키마
- [DEVELOPMENT_GUIDE.md](./DEVELOPMENT_GUIDE.md) - 개발 가이드
- [TODO.md](./project-management/TODO.md) - 작업 목록
