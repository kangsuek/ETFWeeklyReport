╭───────────────────────────────────────────────────────────────────────────────────────────────╮
│ Plan to implement                                                                             │
│                                                                                               │
│ 2-3. 종목 발굴 / 스크리닝 구현 계획                                                           │
│                                                                                               │
│ Context                                                                                       │
│                                                                                               │
│ 현재 stock_catalog 테이블에 ~2500개 종목(KOSPI/KOSDAQ/ETF) 기본 정보가 있으나, 가격·수급      │
│ 데이터가 없어 스크리닝이 불가능. ETF ~700개에 대해 가격/수급 데이터를 일일 수집하고, 조건     │
│ 검색·테마 탐색·추천 기능을 제공하는 /screening 페이지를 추가한다.                             │
│                                                                                               │
│ - 수집 범위: ETF만 (~700개, 수집 시간 ~6분)                                                   │
│ - 대시보드 추천 카드: 포함                                                                    │
│                                                                                               │
│ ---                                                                                           │
│ 변경 파일 목록                                                                                │
│                                                                                               │
│ 백엔드 (신규 2 + 수정 4)                                                                      │
│ 파일: backend/app/services/catalog_data_collector.py                                          │
│ 구분: 신규                                                                                    │
│ 내용: ETF 가격/수급 데이터 수집 서비스                                                        │
│ ────────────────────────────────────────                                                      │
│ 파일: backend/app/routers/screening.py                                                        │
│ 구분: 신규                                                                                    │
│ 내용: 스크리닝 API 라우터 (4 endpoints)                                                       │
│ ────────────────────────────────────────                                                      │
│ 파일: backend/app/database.py                                                                 │
│ 구분: 수정                                                                                    │
│ 내용: stock_catalog에 7개 컬럼 + 3개 인덱스 추가                                              │
│ ────────────────────────────────────────                                                      │
│ 파일: backend/app/models.py                                                                   │
│ 구분: 수정                                                                                    │
│ 내용: 스크리닝 Pydantic 모델 추가                                                             │
│ ────────────────────────────────────────                                                      │
│ 파일: backend/app/main.py                                                                     │
│ 구분: 수정                                                                                    │
│ 내용: screening 라우터 등록                                                                   │
│ ────────────────────────────────────────                                                      │
│ 파일: backend/app/services/scheduler.py                                                       │
│ 구분: 수정                                                                                    │
│ 내용: 매일 16:00 카탈로그 데이터 수집 스케줄 추가                                             │
│ 프론트엔드 (신규 5 + 수정 4)                                                                  │
│ 파일: frontend/src/pages/Screening.jsx                                                        │
│ 구분: 신규                                                                                    │
│ 내용: 스크리닝 페이지 (2탭: 조건 검색 / 테마 탐색)                                            │
│ ────────────────────────────────────────                                                      │
│ 파일: frontend/src/components/screening/ScreeningFilters.jsx                                  │
│ 구분: 신규                                                                                    │
│ 내용: 필터 패널                                                                               │
│ ────────────────────────────────────────                                                      │
│ 파일: frontend/src/components/screening/ScreeningTable.jsx                                    │
│ 구분: 신규                                                                                    │
│ 내용: 결과 테이블 (정렬+페이지네이션)                                                         │
│ ────────────────────────────────────────                                                      │
│ 파일: frontend/src/components/screening/ThemeExplorer.jsx                                     │
│ 구분: 신규                                                                                    │
│ 내용: 테마/섹터 그리드                                                                        │
│ ────────────────────────────────────────                                                      │
│ 파일: frontend/src/components/dashboard/RecommendationCards.jsx                               │
│ 구분: 신규                                                                                    │
│ 내용: 대시보드 추천 카드                                                                      │
│ ────────────────────────────────────────                                                      │
│ 파일: frontend/src/services/api.js                                                            │
│ 구분: 수정                                                                                    │
│ 내용: screeningApi 추가                                                                       │
│ ────────────────────────────────────────                                                      │
│ 파일: frontend/src/App.jsx                                                                    │
│ 구분: 수정                                                                                    │
│ 내용: Screening 라우트 추가                                                                   │
│ ────────────────────────────────────────                                                      │
│ 파일: frontend/src/components/layout/Header.jsx                                               │
│ 구분: 수정                                                                                    │
│ 내용: "종목 발굴" 네비 추가                                                                   │
│ ────────────────────────────────────────                                                      │
│ 파일: frontend/src/pages/Dashboard.jsx                                                        │
│ 구분: 수정                                                                                    │
│ 내용: RecommendationCards 배치                                                                │
│ ---                                                                                           │
│ 단계 1: DB 마이그레이션                                                                       │
│                                                                                               │
│ 파일: backend/app/database.py — init_db() 내 stock_catalog 관련 인덱스 이후                   │
│                                                                                               │
│ 기존 etfs 테이블 마이그레이션 패턴(249-277행)과 동일하게 ALTER TABLE + 중복 무시:             │
│                                                                                               │
│ -- 7개 컬럼 추가                                                                              │
│ ALTER TABLE stock_catalog ADD COLUMN close_price REAL;                                        │
│ ALTER TABLE stock_catalog ADD COLUMN daily_change_pct REAL;                                   │
│ ALTER TABLE stock_catalog ADD COLUMN volume INTEGER;                                          │
│ ALTER TABLE stock_catalog ADD COLUMN weekly_return REAL;                                      │
│ ALTER TABLE stock_catalog ADD COLUMN foreign_net INTEGER;                                     │
│ ALTER TABLE stock_catalog ADD COLUMN institutional_net INTEGER;                               │
│ ALTER TABLE stock_catalog ADD COLUMN catalog_updated_at TIMESTAMP;                            │
│                                                                                               │
│ -- 3개 인덱스 추가                                                                            │
│ CREATE INDEX IF NOT EXISTS idx_stock_catalog_screening                                        │
│     ON stock_catalog(type, is_active, weekly_return);                                         │
│ CREATE INDEX IF NOT EXISTS idx_stock_catalog_sector                                           │
│     ON stock_catalog(sector, is_active);                                                      │
│ CREATE INDEX IF NOT EXISTS idx_stock_catalog_catalog_updated                                  │
│     ON stock_catalog(catalog_updated_at);                                                     │
│                                                                                               │
│ ---                                                                                           │
│ 단계 2: Pydantic 모델                                                                         │
│                                                                                               │
│ 파일: backend/app/models.py — 하단에 추가                                                     │
│                                                                                               │
│ class ScreeningItem(BaseModel):                                                               │
│     ticker: str                                                                               │
│     name: str                                                                                 │
│     type: str                                                                                 │
│     market: Optional[str] = None                                                              │
│     sector: Optional[str] = None                                                              │
│     close_price: Optional[float] = None                                                       │
│     daily_change_pct: Optional[float] = None                                                  │
│     volume: Optional[int] = None                                                              │
│     weekly_return: Optional[float] = None                                                     │
│     foreign_net: Optional[int] = None                                                         │
│     institutional_net: Optional[int] = None                                                   │
│     catalog_updated_at: Optional[str] = None                                                  │
│     is_registered: bool = False  # etfs 테이블에 이미 등록된 종목                             │
│                                                                                               │
│ class ScreeningResponse(BaseModel):                                                           │
│     items: List[ScreeningItem]                                                                │
│     total: int                                                                                │
│     page: int                                                                                 │
│     page_size: int                                                                            │
│                                                                                               │
│ class ThemeGroup(BaseModel):                                                                  │
│     sector: str                                                                               │
│     count: int                                                                                │
│     avg_weekly_return: Optional[float] = None                                                 │
│     top_performers: List[ScreeningItem]                                                       │
│                                                                                               │
│ class RecommendationPreset(BaseModel):                                                        │
│     preset_id: str                                                                            │
│     title: str                                                                                │
│     description: str                                                                          │
│     items: List[ScreeningItem]                                                                │
│                                                                                               │
│ ---                                                                                           │
│ 단계 3: 카탈로그 데이터 수집 서비스                                                           │
│                                                                                               │
│ 파일: backend/app/services/catalog_data_collector.py (신규)                                   │
│                                                                                               │
│ ticker_catalog_collector.py의 스크래핑 패턴(headers, rate limiter, retry) 재사용.             │
│                                                                                               │
│ 수집 2단계                                                                                    │
│                                                                                               │
│ Phase 1 — ETF 목록 페이지 일괄 (~20초):                                                       │
│ - https://finance.naver.com/sise/etf.naver 목록 페이지에서 close_price, daily_change_pct,     │
│ volume 파싱                                                                                   │
│ - _collect_etf_stocks_requests() 패턴 재사용, 추가 컬럼 파싱                                  │
│                                                                                               │
│ Phase 2 — 개별 종목 수급 (~5분):                                                              │
│ - https://finance.naver.com/item/frgn.naver?code={ticker} 에서 foreign_net, institutional_net │
│  수집                                                                                         │
│ - data_collector.py의 투자자 매매동향 패턴 참조                                               │
│ - weekly_return = (현재가 - 5일전) / 5일전 * 100                                              │
│                                                                                               │
│ 스케줄러 연동 (scheduler.py)                                                                  │
│                                                                                               │
│ # 매일 16:00 KST (장 마감 30분 후)                                                            │
│ catalog_data_job = self.scheduler.add_job(                                                    │
│     self.collect_catalog_data,                                                                │
│     trigger=CronTrigger(day_of_week='mon-fri', hour=16, minute=0, timezone=KST),              │
│     id='catalog_data_collection', name='ETF 카탈로그 가격/수급 수집'                          │
│ )                                                                                             │
│                                                                                               │
│ ---                                                                                           │
│ 단계 4: 스크리닝 API 라우터                                                                   │
│                                                                                               │
│ 파일: backend/app/routers/screening.py (신규)                                                 │
│ 등록: main.py → app.include_router(screening.router, prefix="/api/screening",                 │
│ tags=["Screening"])                                                                           │
│                                                                                               │
│ GET /api/screening — 조건 검색                                                                │
│ ┌────────────────────────────┬───────┬─────────────────┬──────────────────────┐               │
│ │          파라미터          │ 타입  │     기본값      │         설명         │               │
│ ├────────────────────────────┼───────┼─────────────────┼──────────────────────┤               │
│ │ q                          │ str   │ None            │ 종목명/코드 검색     │               │
│ ├────────────────────────────┼───────┼─────────────────┼──────────────────────┤               │
│ │ type                       │ str   │ "ETF"           │ ETF / STOCK / ALL    │               │
│ ├────────────────────────────┼───────┼─────────────────┼──────────────────────┤               │
│ │ sector                     │ str   │ None            │ 섹터 필터            │               │
│ ├────────────────────────────┼───────┼─────────────────┼──────────────────────┤               │
│ │ min_weekly_return          │ float │ None            │ 최소 주간수익률      │               │
│ ├────────────────────────────┼───────┼─────────────────┼──────────────────────┤               │
│ │ max_weekly_return          │ float │ None            │ 최대 주간수익률      │               │
│ ├────────────────────────────┼───────┼─────────────────┼──────────────────────┤               │
│ │ foreign_net_positive       │ bool  │ None            │ 외국인 순매수만      │               │
│ ├────────────────────────────┼───────┼─────────────────┼──────────────────────┤               │
│ │ institutional_net_positive │ bool  │ None            │ 기관 순매수만        │               │
│ ├────────────────────────────┼───────┼─────────────────┼──────────────────────┤               │
│ │ sort_by                    │ str   │ "weekly_return" │ 정렬 기준            │               │
│ ├────────────────────────────┼───────┼─────────────────┼──────────────────────┤               │
│ │ sort_dir                   │ str   │ "desc"          │ asc/desc             │               │
│ ├────────────────────────────┼───────┼─────────────────┼──────────────────────┤               │
│ │ page                       │ int   │ 1               │ 페이지               │               │
│ ├────────────────────────────┼───────┼─────────────────┼──────────────────────┤               │
│ │ page_size                  │ int   │ 20              │ 페이지 크기 (max 50) │               │
│ └────────────────────────────┴───────┴─────────────────┴──────────────────────┘               │
│ - 동적 WHERE 절 (non-None 파라미터만)                                                         │
│ - is_registered: LEFT JOIN etfs ON stock_catalog.ticker = etfs.ticker                         │
│ - 60초 TTL 캐시                                                                               │
│                                                                                               │
│ GET /api/screening/themes — 테마 탐색                                                         │
│                                                                                               │
│ GROUP BY sector + 각 섹터 top 3 (weekly_return DESC)                                          │
│                                                                                               │
│ GET /api/screening/recommendations — 추천 프리셋 (limit 기본 5)                               │
│                                                                                               │
│ 1. weekly_top_return — "주간 수익률 상위"                                                     │
│ 2. foreign_buying — "외국인 순매수 상위"                                                      │
│ 3. institutional_buying — "기관 순매수 상위"                                                  │
│ 4. high_volume — "거래량 상위"                                                                │
│ 5. weekly_worst_return — "주간 하락 상위 (역발상)"                                            │
│                                                                                               │
│ POST /api/screening/collect-data — 수동 수집 트리거                                           │
│                                                                                               │
│ ---                                                                                           │
│ 단계 5: 프론트엔드 API + 라우트 + 네비                                                        │
│                                                                                               │
│ api.js — screeningApi 추가 (search, getThemes, getRecommendations, collectData)               │
│                                                                                               │
│ App.jsx — const Screening = lazy(() => import('./pages/Screening.jsx')) + Route               │
│                                                                                               │
│ Header.jsx — Dashboard와 Portfolio 사이에 "종목 발굴" 링크 (데스크톱 + 모바일)                │
│                                                                                               │
│ ---                                                                                           │
│ 단계 6: 스크리닝 페이지 + 컴포넌트 3개                                                        │
│                                                                                               │
│ Screening.jsx                                                                                 │
│                                                                                               │
│ PageHeader (title="종목 발굴")                                                                │
│ ├── 탭 바: [조건 검색, 테마 탐색]                                                             │
│ ├── [탭1] ScreeningFilters + ScreeningTable                                                   │
│ └── [탭2] ThemeExplorer                                                                       │
│                                                                                               │
│ ScreeningFilters.jsx                                                                          │
│                                                                                               │
│ - 검색 입력 (종목명/코드)                                                                     │
│ - 주간수익률 범위 (min/max)                                                                   │
│ - 외국인 순매수 토글, 기관 순매수 토글                                                        │
│ - "검색" + "초기화" 버튼                                                                      │
│ - 마지막 데이터 갱신 시각 표시                                                                │
│                                                                                               │
│ ScreeningTable.jsx                                                                            │
│                                                                                               │
│ - 정렬 가능 컬럼: 종목명, 현재가, 등락률, 거래량, 주간수익률, 외국인, 기관                    │
│ - 각 행에 "내 종목에 추가" 버튼 (등록 시 settingsApi.createStock() 호출, 이미 등록 시 비활성) │
│ - 페이지네이션 (이전/다음 + 페이지 번호)                                                      │
│                                                                                               │
│ ThemeExplorer.jsx                                                                             │
│                                                                                               │
│ - 섹터별 카드 그리드 (2~3열)                                                                  │
│ - 각 카드: 섹터명, ETF 수, 평균 주간수익률, top 3 종목                                        │
│ - 카드 클릭 → 탭1 전환 + 해당 섹터 필터 적용                                                  │
│                                                                                               │
│ ---                                                                                           │
│ 단계 7: 대시보드 추천 카드                                                                    │
│                                                                                               │
│ 파일: frontend/src/components/dashboard/RecommendationCards.jsx (신규)                        │
│                                                                                               │
│ - screeningApi.getRecommendations(3) (staleTime: 5분)                                         │
│ - 프리셋별 카드: "주간 수익률 상위", "외국인 매수 급증", "기관 매수 상위"                     │
│ - 각 카드에 top 3 종목 (종목명, 현재가, 등락률, 주간수익률)                                   │
│ - "더보기" → /screening 링크                                                                  │
│ - 데이터 없으면 숨김                                                                          │
│                                                                                               │
│ Dashboard.jsx: <PortfolioHeatmap> 아래, <ETFCardGrid> 위에 배치                               │
│                                                                                               │
│ ---                                                                                           │
│ 구현 순서                                                                                     │
│ ┌──────┬─────────────────────────────────────────────────────────┐                            │
│ │ 순서 │                          작업                           │                            │
│ ├──────┼─────────────────────────────────────────────────────────┤                            │
│ │ 1    │ DB 마이그레이션 (database.py)                           │                            │
│ ├──────┼─────────────────────────────────────────────────────────┤                            │
│ │ 2    │ Pydantic 모델 (models.py)                               │                            │
│ ├──────┼─────────────────────────────────────────────────────────┤                            │
│ │ 3    │ CatalogDataCollector 서비스 (신규)                      │                            │
│ ├──────┼─────────────────────────────────────────────────────────┤                            │
│ │ 4    │ 스크리닝 API 라우터 (신규) + main.py 등록               │                            │
│ ├──────┼─────────────────────────────────────────────────────────┤                            │
│ │ 5    │ 스케줄러 연동 (scheduler.py)                            │                            │
│ ├──────┼─────────────────────────────────────────────────────────┤                            │
│ │ 6    │ 프론트 API 서비스 (api.js)                              │                            │
│ ├──────┼─────────────────────────────────────────────────────────┤                            │
│ │ 7    │ 스크리닝 페이지 + 3개 컴포넌트                          │                            │
│ ├──────┼─────────────────────────────────────────────────────────┤                            │
│ │ 8    │ 라우트 + 네비게이션 (App.jsx, Header.jsx)               │                            │
│ ├──────┼─────────────────────────────────────────────────────────┤                            │
│ │ 9    │ 대시보드 추천 카드 (RecommendationCards, Dashboard.jsx) │                            │
│ ├──────┼─────────────────────────────────────────────────────────┤                            │
│ │ 10   │ 빌드 검증 (npx vite build)                              │                            │
│ └──────┴─────────────────────────────────────────────────────────┘                            │
│ 제외 (나중에)                                                                                 │
│                                                                                               │
│ - 개별 주식(KOSPI/KOSDAQ) 가격/수급 수집                                                      │
│ - 인기 종목 추적 (사용자 분석 인프라 필요)                                                    │
│ - 커스텀 프리셋 저장                                                                          │
│ - 고급 변동성 지표                                                                            │
│                                                                                               │
│ 검증                                                                                          │
│                                                                                               │
│ 1. cd frontend && npx vite build — 빌드 성공                                                  │
│ 2. 백엔드 시작 → GET /api/screening 응답 확인                                                 │
│ 3. /screening 페이지 → 필터 + 테이블 + 테마 탐색                                              │
│ 4. 대시보드 → 추천 카드 표시                                                                  │
│ 5. "내 종목에 추가" → Settings에서 등록 확인                                                  │
│ 6. 다크모드 전환 확인                                                                         │
╰───────────────────────────────────────────────────────────────────────────────────────────────╯