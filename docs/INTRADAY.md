# 분봉 차트: 조회 방식 및 수집

분봉 차트의 **조회 흐름**, **자동 갱신**, **데이터 수집** 방식을 한 문서로 정리합니다.

---

## 1. 조회 방식 개요

- **방식**: 페이지 로드 시 1회 호출 + **30초마다 자동 갱신**
- **API**: `GET /api/etfs/{ticker}/intraday`
- **파라미터**: `target_date`(선택), `auto_collect`(기본 true), `force_refresh`(캐시 무시)

### 프론트엔드 (ETFDetail.jsx)

- `refetchInterval: 30000` → 30초마다 자동 갱신
- `refetchOnMount: true` → 컴포넌트 재마운트 시 stale이면 갱신
- `staleTime: 30초` → 30초 동안 캐시 사용
- 수동 새로고침 버튼 제공

### 백엔드 조회 순서

1. 캐시 확인 (30초 TTL)  
2. DB 조회  
3. 데이터 없으면 마지막 거래일 확인  
4. `auto_collect=true`이면 자동 수집(스크래핑) 후 재조회  

**캐시**: 키 `intraday:{ticker}:{date}`, TTL 30초. **빈 결과는 캐시하지 않음** (다음 요청에서 자동 수집 재시도 가능).

---

## 2. 데이터 수집

### 네이버 금융 제공 방식

- 분봉은 **최신(15:30 근처)부터 역순** 제공
- 페이지당 약 10개, 장 전체(09:00~15:30) 수집 시 **약 40페이지** 필요
- 기본 페이지 수를 40으로 설정해 장 시작(09:00) 데이터까지 수집

### 수집 흐름

1. 기본 40페이지 수집  
2. 첫 데이터 시간 확인  
3. 09:00 이전이면 추가 20페이지 수집 후 병합  
4. DB 저장  

### 관련 코드

- `backend/app/services/intraday_collector.py`: 기본 페이지 40, 09:00 이전 시 추가 수집
- `backend/app/routers/etfs.py`: 자동/수동 수집 시 `pages=40` 사용

---

## 3. 문제 해결

| 현상 | 원인 | 조치 |
|------|------|------|
| 30초마다 자동 갱신 안 됨 | `refetchInterval` 미설정 | `refetchInterval: 30000` 추가 |
| 프론트에서 분봉 수집 안 됨 | 빈 결과가 캐시되어 자동 수집 미실행 | 백엔드에서 빈 결과 미캐시 처리 |
| 수집이 중간에 끊김 | 타임아웃 | 프론트 분봉 API 타임아웃을 `LONG_API_TIMEOUT`(예: 10분)으로 확대 |
| 장 시작 데이터 누락 | 페이지 수 부족(20페이지) | 기본 40페이지 사용, 09:00 이전이면 추가 수집 |

---

## 4. 요약

| 항목 | 내용 |
|------|------|
| 조회 | 페이지 로드 1회 + 30초마다 자동 갱신 |
| 캐시 | 백엔드 30초 TTL, 프론트 30초 staleTime |
| 자동 수집 | DB에 데이터 없을 때 스크래핑 후 저장 |
| 수집 범위 | 09:00~15:30, 약 40페이지(390분봉) |
